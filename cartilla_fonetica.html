<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>LeerKids · Cartilla Fonética (One‑Page)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap"
      rel="stylesheet"
    />
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <style>
      html,
      body {
        font-family: "Nunito", system-ui, -apple-system, Segoe UI, Roboto;
      }
      .clamp-2 {
        display: -webkit-box;
        -webkit-box-orient: vertical;
        overflow: hidden;
        line-clamp: 2;
        -webkit-line-clamp: 2;
      }

      /* Palabras/frases */
      .word-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 3.5rem;
        border-radius: 1rem;
        font-weight: 900;
      }
      @media (min-width: 640px) {
        .word-btn {
          height: 4rem;
        }
      }
      .drop-pill {
        display: inline-flex;
        align-items: center;
        height: 2.75rem;
        padding: 0 0.75rem;
        border-radius: 9999px;
        font-weight: 800;
        cursor: pointer;
      }
      .btn-next[disabled] {
        opacity: 0.5;
        cursor: not-allowed;
      }

      /* lightweight helpers used in cartilla */
      .option-btn {
        cursor: pointer;
      }
      .draggable {
        cursor: grab;
      }
      .droppable {
        min-height: 56px;
      }
      .page-viewport {
        max-height: 72svh;
      }
      .no-select {
        -webkit-user-select: none;
        user-select: none;
      }
    </style>
  </head>
  <body class="bg-slate-50 text-slate-900">
    <div class="max-w-6xl mx-auto p-4 sm:p-6">
      <!-- Header / Progress -->
      <header
        class="sticky top-0 z-40 bg-white/90 backdrop-blur border-b border-slate-200 mb-4 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3"
      >
        <div>
          <h1
            class="text-2xl sm:text-3xl font-extrabold tracking-tight text-sky-900"
          >
            LeerKids · Cartilla Fonética
          </h1>
          <p class="text-sm text-slate-600">
            Juegos para aprender a leer (5–8 años). Todo en una sola página, sin
            instalaciones.
          </p>
        </div>
        <div class="flex items-center gap-3">
          <div
            id="stars"
            class="text-amber-500 text-2xl"
            title="Progreso"
          ></div>
          <button
            id="btnResetProgress"
            class="px-3 py-2 rounded-xl border border-slate-200 font-bold text-sm"
          >
            Reiniciar progreso
          </button>
        </div>
      </header>

      <!-- Tabs / Router -->
      <nav class="bg-white border border-slate-200 rounded-2xl shadow-sm mb-4">
        <div class="flex flex-wrap gap-2 px-2 py-2">
          <button
            data-section="#viewer"
            class="tab px-3 py-2 rounded-xl bg-sky-100 hover:bg-sky-200 text-sky-900"
          >
            Visor del libro
          </button>
          <button
            data-section="#syllables"
            class="tab px-3 py-2 rounded-xl hover:bg-sky-100"
          >
            Silabas
          </button>
          <button
            data-section="#sylQuiz"
            class="tab px-3 py-2 rounded-xl hover:bg-sky-100"
          >
            Quiz silabas
          </button>
          <button
            data-section="#listen"
            class="tab px-3 py-2 rounded-xl hover:bg-sky-100"
          >
            Escucha y elige
          </button>
          <button
            data-section="#build"
            class="tab px-3 py-2 rounded-xl hover:bg-sky-100"
          >
            Arma la palabra
          </button>
        </div>
      </nav>

      <main class="space-y-8">
        <!-- Visor del libro -->
        <section id="viewer" class="section hidden">
          <div
            class="p-4 rounded-2xl bg-white border border-slate-200 shadow-sm"
          >
            <div class="flex items-center justify-between gap-3 mb-3">
              <div class="flex items-center gap-2">
                <button
                  id="prevPage"
                  class="px-3 py-2 rounded-xl border border-slate-200"
                >
                  ◀
                </button>
                <button
                  id="nextPage"
                  class="px-3 py-2 rounded-xl border border-slate-200"
                >
                  ▶
                </button>
                <span class="text-sm text-slate-600"
                  >Página <span id="pageNum">1</span> /
                  <span id="pageTotal">32</span></span
                >
              </div>
              <div class="flex items-center gap-2">
                <button
                  id="fullBtn"
                  class="px-3 py-2 rounded-xl border border-slate-200"
                  title="Pantalla completa"
                >
                  ⛶
                </button>
                <label class="text-sm text-slate-600">Zoom</label>
                <input
                  id="zoom"
                  type="range"
                  min="50"
                  max="150"
                  value="100"
                  class="w-40"
                />
              </div>
            </div>
            <div
              class="border border-slate-200 rounded-xl overflow-hidden bg-slate-50 grid place-items-center page-viewport"
            >
              <img
                id="bookImg"
                alt="Página"
                class="max-h-[72svh] w-full h-auto object-contain"
              />
            </div>
            <div class="mt-3 text-xs text-slate-500">
              Coloca los archivos <code>page_1.svg</code> …
              <code>page_32.svg</code> dentro de la carpeta
              <code>book/</code> junto a este HTML que este HTML. Se cargarán
              automáticamente.
            </div>
          </div>
        </section>
        <!-- Juego: Silabas (tablero) -->
        <section id="syllables" class="section hidden">
          <div
            class="p-4 rounded-2xl bg-white border border-slate-200 shadow-sm space-y-5"
          >
            <div>
              <h2 class="font-bold text-lg mb-2">Tablero de silabas</h2>
              <div class="text-sm text-slate-600 mb-2">
                Toca para escuchar las combinaciones disponibles.
              </div>
              <div
                id="sylBoard"
                class="grid grid-cols-5 sm:grid-cols-10 gap-2"
              ></div>
            </div>
          </div>
        </section>

        <!-- Juego: Silabas (quiz) -->
        <section id="sylQuiz" class="section hidden">
          <div
            class="p-4 rounded-2xl bg-white border border-slate-200 shadow-sm"
          >
            <div class="flex items-center justify-between mb-3">
              <h2 class="font-bold text-lg">Quiz de silabas</h2>
              <div class="flex items-center gap-2">
                <button
                  id="sylRehear"
                  class="px-3 py-2 rounded-xl border border-slate-200"
                >
                  Re-escuchar
                </button>
                <button
                  id="sylNext"
                  class="px-3 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white font-extrabold"
                >
                  Siguiente
                </button>
              </div>
            </div>
            <div class="text-sm text-slate-600 mb-2">
              Escucha la silaba y elige la correcta.
            </div>
            <div id="sylQuestion" class="text-2xl font-extrabold mb-2"></div>
            <div
              id="sylOptions"
              class="grid grid-cols-2 sm:grid-cols-4 gap-2"
            ></div>
            <div id="sylMsg" class="mt-3 text-sm"></div>
          </div>
        </section>

        <!-- Juego: Escucha y elige (palabras) -->
        <section id="listen" class="section hidden">
          <div
            class="p-4 rounded-2xl bg-white border border-slate-200 shadow-sm"
          >
            <div class="mb-2">
              <h2 class="font-bold text-lg">Escucha y elige (palabras)</h2>
            </div>
            <div class="text-sm text-slate-600">
              Escucha la palabra y toca la opción correcta.
            </div>
            <div id="listenWord" class="text-3xl font-black my-3 hidden"></div>
            <div
              id="listenOptions"
              class="grid grid-cols-2 sm:grid-cols-4 gap-2 mt-2"
            ></div>
            <div class="mt-4 flex items-center gap-2">
              <button
                id="listenHear"
                class="px-3 py-2 rounded-xl border border-slate-200"
              >
                Re‑escuchar 🔊
              </button>
              <button
                id="listenNext"
                class="px-3 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white font-extrabold"
              >
                Siguiente ➜
              </button>
            </div>
            <div id="listenMsg" class="mt-3 text-sm"></div>
          </div>
        </section>
        <!-- Juego: Arma la palabra (drag&drop de sílabas) -->
        <section id="build" class="section hidden">
          <div
            class="p-4 rounded-2xl bg-white border border-slate-200 shadow-sm"
          >
            <h2 class="font-bold text-lg mb-2">Arma la palabra</h2>
            <p class="text-sm text-slate-600 mb-3">
              Arrastra las sílabas al orden correcto.
            </p>
            <div class="flex flex-col sm:flex-row gap-3">
              <div class="flex-1">
                <div id="buildTarget" class="text-xl font-bold mb-2"></div>
                <div
                  id="dropZone"
                  class="droppable flex flex-wrap gap-2 p-3 rounded-xl bg-slate-50 border min-h-[72px]"
                ></div>
                <div id="buildMsg" class="mt-3 text-sm"></div>
              </div>
              <div class="w-full sm:w-64">
                <div class="text-sm text-slate-600 mb-1">
                  Sílabas disponibles
                </div>
                <div id="tiles" class="grid grid-cols-3 gap-2"></div>
                <div class="mt-3 flex items-center gap-2">
                  <button
                    id="buildNew"
                    class="px-3 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white font-extrabold"
                  >
                    Nueva palabra
                  </button>
                  <button
                    id="buildHear"
                    class="px-3 py-2 rounded-xl border border-slate-200"
                  >
                    Escuchar
                  </button>
                </div>
              </div>
            </div>
          </div>
        </section>
      </main>

      <footer class="mt-10 text-center text-xs text-slate-500">
        © <span id="year"></span> LeerKids · Hecho con cariño boricua 💙
      </footer>
    </div>

    <script>
      // ===== Utilidades =====
      function rand(n) {
        return Math.floor(Math.random() * n);
      }
      function shuffle(arr) {
        return arr
          .map(function (v) {
            return [Math.random(), v];
          })
          .sort(function (a, b) {
            return a[0] - b[0];
          })
          .map(function (x) {
            return x[1];
          });
      }
      function clamp(v, min, max) {
        return Math.max(min, Math.min(max, v));
      }

      // ===== Progreso (estrellas) =====
      var PROG_KEY = "leerkids-stars-v1";
      function getStars() {
        return parseInt(localStorage.getItem(PROG_KEY) || "0", 10);
      }
      function setStars(v) {
        localStorage.setItem(PROG_KEY, String(Math.max(0, v)));
        renderStars();
      }
      function addStar(n) {
        if (n === void 0) n = 1;
        setStars(getStars() + n);
      }
      function renderStars() {
        var n = clamp(getStars(), 0, 999);
        var blocks = Math.floor(n / 5);
        var rest = n % 5;
        var html = "";
        for (var i = 0; i < blocks; i++) html += "⭐⭐⭐⭐⭐ ";
        for (var j = 0; j < rest; j++) html += "⭐";
        if (!html) html = "—";
        $("#stars").html(html);
      }

      // ===== Contenido base =====
      var VOWELS = ["a", "e", "i", "o", "u"];
      var DEFAULT_CONSONANTS = [
        "m",
        "p",
        "l",
        "s",
        "t",
        "n",
        "d",
        "c",
        "r",
        "b",
        "f",
      ];
      function genSyllables(cons) {
        var out = [];
        cons.forEach(function (c) {
          VOWELS.forEach(function (v) {
            out.push(c + v);
          });
        });
        return out;
      }

      // ===== Palabras =====
      var WORDS = [
        { word: "mamá", syl: ["ma", "má"] },
        { word: "pato", syl: ["pa", "to"] },
        { word: "luna", syl: ["lu", "na"] },
        { word: "sapo", syl: ["sa", "po"] },
        { word: "taza", syl: ["ta", "za"] },
        { word: "mesa", syl: ["me", "sa"] },
        { word: "toma", syl: ["to", "ma"] },
        { word: "mimo", syl: ["mi", "mo"] },
      ];

      // ===== Voz (Web Speech API) =====
      var VOICES = [];
      function loadVoices() {
        if (!("speechSynthesis" in window)) return;
        VOICES = window.speechSynthesis.getVoices().filter(function (v) {
          return v.lang && v.lang.indexOf("es") === 0;
        });
      }
      if ("speechSynthesis" in window) {
        loadVoices();
        window.speechSynthesis.onvoiceschanged = loadVoices;
      }
      function speak(txt) {
        if (!("speechSynthesis" in window)) return;
        var u = new SpeechSynthesisUtterance(txt);
        if (VOICES.length) u.voice = VOICES[0];
        u.rate = 1;
        u.volume = 1;
        try {
          window.speechSynthesis.cancel();
          window.speechSynthesis.speak(u);
        } catch (e) {}
      }

      // ===== Router =====
      function showSection(sel) {
        $(".section").addClass("hidden");
        $(sel).removeClass("hidden");
        $(".tab")
          .removeClass("bg-sky-100 text-sky-900")
          .addClass("text-slate-800");
        $('.tab[data-section="' + sel + '"]').addClass(
          "bg-sky-100 text-sky-900"
        );
      }

      // ===== Visor de páginas SVG =====
      var PAGE_TOTAL = 32; // ajusta si tu libro tiene más/menos páginas
      var pageIdx = 1;
      function pagePath(i) {
        return "book/page_" + i + ".svg";
      }
      function renderPage() {
        $("#pageNum").text(pageIdx);
        $("#pageTotal").text(PAGE_TOTAL);
        var url = pagePath(pageIdx);
        var $img = $("#bookImg");
        $img
          .off("error")
          .attr("src", url)
          .on("error", function () {
            $(this).attr("alt", "No se encontró la imagen: " + url);
          });
      }
      function viewerIsVisible() {
        return $("#viewer").is(":visible");
      }
      function nextPage() {
        pageIdx = Math.min(PAGE_TOTAL, pageIdx + 1);
        renderPage();
      }
      function prevPage() {
        pageIdx = Math.max(1, pageIdx - 1);
        renderPage();
      }
      $(document).on("keydown", function (e) {
        if (!viewerIsVisible()) return;
        if (e.key === "ArrowRight") {
          e.preventDefault();
          nextPage();
        } else if (e.key === "ArrowLeft") {
          e.preventDefault();
          prevPage();
        }
      });
      (function () {
        var startX = null;
        var el = document.querySelector("#viewer .page-viewport");
        if (el) {
          el.addEventListener(
            "touchstart",
            function (ev) {
              if (!viewerIsVisible()) return;
              startX =
                ev.touches && ev.touches[0] ? ev.touches[0].clientX : null;
            },
            { passive: true }
          );
          el.addEventListener(
            "touchend",
            function (ev) {
              if (!viewerIsVisible() || startX === null) return;
              var x =
                ev.changedTouches && ev.changedTouches[0]
                  ? ev.changedTouches[0].clientX
                  : startX;
              var dx = x - startX;
              if (Math.abs(dx) > 40) {
                if (dx < 0) nextPage();
                else prevPage();
              }
              startX = null;
            },
            { passive: true }
          );
        }
      })();
      $("#fullBtn").on("click", function () {
        var el = document.querySelector("#viewer .page-viewport");
        if (!document.fullscreenElement) {
          if (el && el.requestFullscreen) el.requestFullscreen();
        } else {
          if (document.exitFullscreen) document.exitFullscreen();
        }
      });

      // ===== Sílabas =====
      var activeConsonants = DEFAULT_CONSONANTS.slice();

      function buildSylBoard() {
        var list = genSyllables(activeConsonants);
        var $b = $("#sylBoard");
        $b.empty();
        list.forEach(function (s) {
          var $btn = $(
            '<button class="px-3 py-2 rounded-xl border border-slate-200">' +
              s +
              "</button>"
          );
          $btn.on("click", function () {
            speak(s);
          });
          $b.append($btn);
        });
      }
      var sylAnswer = "";
      function nextSylQuiz() {
        var list = genSyllables(activeConsonants);
        if (list.length < 4) {
          $("#sylMsg").text(
            "Activa mas consonantes para ver mas combinaciones."
          );
          return;
        }
        sylAnswer = list[rand(list.length)];
        speak(sylAnswer);
        $("#sylQuestion").text("¿Cuál sílaba escuchaste?");
        var opts = shuffle(
          [sylAnswer].concat(
            shuffle(
              list.filter(function (x) {
                return x !== sylAnswer;
              })
            ).slice(0, 3)
          )
        );
        var $box = $("#sylOptions");
        $box.empty();
        opts.forEach(function (opt) {
          var $b = $(
            '<button class="option-btn px-3 py-3 rounded-xl bg-slate-100 hover:bg-slate-200 font-semibold">' +
              opt +
              "</button>"
          );
          $b.on("click", function () {
            var correct = opt === sylAnswer;
            $b.removeClass("bg-slate-100 hover:bg-slate-200").addClass(
              correct ? "bg-emerald-200" : "bg-rose-200"
            );
            $("#sylMsg").html(
              correct
                ? "✅ ¡Bien! +1 ⭐"
                : "❌ Ups, era <b>" + sylAnswer + "</b>"
            );
            if (correct) addStar(1);
          });
          $box.append($b);
        });
      }

      // ===== Escucha y elige (palabras) =====
      var listenIdx = 0;
      var listenAnswer = "";
      function nextListen() {
        if (WORDS.length < 4) {
          $("#listenMsg").text("No hay suficientes palabras disponibles.");
          return;
        }
        listenIdx = rand(WORDS.length);
        listenAnswer = WORDS[listenIdx].word;
        $("#listenWord").addClass("hidden").text(listenAnswer);
        var pool = shuffle(
          WORDS.map(function (w) {
            return w.word;
          })
        );
        var opts = shuffle(
          [listenAnswer].concat(
            pool
              .filter(function (w) {
                return w !== listenAnswer;
              })
              .slice(0, 3)
          )
        );
        var $box = $("#listenOptions");
        $box.empty();
        opts.forEach(function (opt) {
          var $b = $(
            '<button class="option-btn px-3 py-4 rounded-2xl bg-slate-100 hover:bg-slate-200 text-lg font-semibold">' +
              opt +
              "</button>"
          );
          $b.on("click", function () {
            var ok = opt === listenAnswer;
            $b.removeClass("bg-slate-100 hover:bg-slate-200").addClass(
              ok ? "bg-emerald-200" : "bg-rose-200"
            );
            $("#listenMsg").html(
              ok ? "✅ ¡Excelente! +1 ⭐" : "❌ Era <b>" + listenAnswer + "</b>"
            );
            if (ok) addStar(1);
          });
          $box.append($b);
        });
        speak(listenAnswer);
      }

      // ===== Arma la palabra =====
      function pickWord() {
        return WORDS[rand(WORDS.length)];
      }
      var buildCurrent = null;
      function newBuild() {
        if (WORDS.length === 0) {
          $("#buildMsg").text(
            "No hay palabras disponibles. Agrega mas en el codigo."
          );
          return;
        }
        buildCurrent = pickWord();
        $("#buildTarget").text("Palabra: " + buildCurrent.word);
        $("#dropZone").empty();
        var slots = buildCurrent.syl.length;
        var i;
        for (i = 0; i < slots; i++) {
          (function () {
            var slot = $(
              '<div data-idx="' +
                i +
                '" class="droppable grid place-items-center w-20 h-14 rounded-xl border-2 border-dashed border-slate-300 bg-slate-50"></div>'
            );
            slot.on("dragover", function (e) {
              e.preventDefault();
              slot.addClass("ring-2 ring-sky-300");
            });
            slot.on("dragleave", function () {
              slot.removeClass("ring-2 ring-sky-300");
            });
            slot.on("drop", function (e) {
              e.preventDefault();
              slot.removeClass("ring-2 ring-sky-300");
              var id = e.originalEvent.dataTransfer.getData("text/plain");
              var $tile = $("#" + id);
              slot.empty().append($tile.removeClass("opacity-70"));
              checkBuild();
            });
            $("#dropZone").append(slot);
          })();
        }
        var pool = shuffle(buildCurrent.syl.slice());
        var $tiles = $("#tiles");
        $tiles.empty();
        pool.forEach(function (sy, idx) {
          var id = "tile_" + idx + "_" + Date.now();
          var $t = $(
            '<div id="' +
              id +
              '" draggable="true" class="draggable px-3 py-2 rounded-xl border border-slate-200 font-semibold text-center">' +
              sy +
              "</div>"
          );
          $t.on("dragstart", function (e) {
            e.originalEvent.dataTransfer.setData("text/plain", id);
            $t.addClass("opacity-70");
          });
          $t.on("dragend", function () {
            $t.removeClass("opacity-70");
          });
          $tiles.append($t);
        });
        $("#buildMsg").text("Arrastra cada sílaba a su lugar.");
      }
      function checkBuild() {
        if (!buildCurrent) return;
        var slots = $("#dropZone .droppable");
        var arr = [];
        slots.each(function () {
          arr.push($(this).text().trim());
        });
        if (
          arr.filter(function (x) {
            return !!x;
          }).length !== buildCurrent.syl.length
        )
          return;
        var okb = arr.every(function (s, i) {
          return s === buildCurrent.syl[i];
        });
        $("#buildMsg").html(
          okb ? "✅ ¡Perfecto! +2 ⭐" : "❌ Revisa el orden."
        );
        if (okb) addStar(2);
      }

      // ===== Eventos de inicio =====
      $(document).ready(function () {
        $("#year").text(new Date().getFullYear());
        renderStars();
        $(".tab").on("click", function () {
          showSection($(this).data("section"));
        });
        showSection("#viewer");

        // Visor
        renderPage();
        $("#prevPage").on("click", function () {
          prevPage();
        });
        $("#nextPage").on("click", function () {
          nextPage();
        });
        $("#zoom").on("input", function () {
          $("#bookImg").css("transform", "scale(" + this.value / 100 + ")");
        });
        // Silabas
        buildSylBoard();
        nextSylQuiz();
        $("#sylRehear").on("click", function () {
          speak(sylAnswer);
        });
        $("#sylNext").on("click", function () {
          nextSylQuiz();
        });

        // Listen
        nextListen();
        $("#listenHear").on("click", function () {
          speak(listenAnswer);
        });
        $("#listenNext").on("click", function () {
          nextListen();
        });

        // Build
        newBuild();
        $("#buildNew").on("click", function () {
          newBuild();
        });
        $("#buildHear").on("click", function () {
          if (buildCurrent) speak(buildCurrent.word);
        });

        // Reset progreso
        $("#btnResetProgress").on("click", function () {
          if (confirm("¿Borrar estrellas guardadas?")) setStars(0);
        });
      });
    </script>
  </body>
</html>
