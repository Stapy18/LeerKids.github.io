<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>LeerKids — Aprende a leer (ES)</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap"
      rel="stylesheet"
    />
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <script>
      /* ===== Tailwind dark mode por clase ===== */
      tailwind.config = {
        darkMode: "class",
      };
    </script>

    <style>
      html,
      body {
        font-family: "Nunito", system-ui, -apple-system, Segoe UI, Roboto;
      }

      /* Globos */
      @keyframes float-up {
        0% {
          transform: translateY(110%);
          opacity: 0;
        }
        8% {
          opacity: 1;
        }
        100% {
          transform: translateY(-600%);
          opacity: 0;
        }
      }
      .balloon {
        position: absolute;
        width: 68px;
        height: 68px;
        border-radius: 9999px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 900;
        box-shadow: 0 10px 22px rgba(15, 23, 42, 0.18);
        animation: float-up var(--dur, 4s) linear forwards;
        user-select: none;
        -webkit-user-select: none;
        color: #fff;
        text-shadow: 0 1px 1px rgba(0, 0, 0, 0.25),
          0 2px 6px rgba(0, 0, 0, 0.25);
      }
      .balloon::after {
        content: "";
        position: absolute;
        bottom: -8px;
        left: 50%;
        transform: translateX(-50%);
        width: 0;
        height: 0;
        border-left: 6px solid transparent;
        border-right: 6px solid transparent;
        border-top: 10px solid rgba(0, 0, 0, 0.25);
      }
      .balloon.pop {
        transform: scale(0.6);
        opacity: 0.1;
        transition: 0.25s ease;
      }

      /* Palabras/frases */
      .word-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 3.5rem;
        border-radius: 1rem;
        font-weight: 900;
      }
      @media (min-width: 640px) {
        .word-btn {
          height: 4rem;
        }
      }
      .drop-pill {
        display: inline-flex;
        align-items: center;
        height: 2.75rem;
        padding: 0 0.75rem;
        border-radius: 9999px;
        font-weight: 800;
        cursor: pointer;
      }
      .btn-next[disabled] {
        opacity: 0.5;
        cursor: not-allowed;
      }
    </style>

    <!-- Carga SOLO el archivo JS de lecciones -->
    <script src="lessons.js"></script>
  </head>
  <body
    class="bg-slate-50 dark:bg-slate-900 text-slate-900 dark:text-slate-100"
  >
    <!-- Header compacto -->
    <header
      class="sticky top-0 z-40 bg-white/90 dark:bg-slate-900/90 backdrop-blur border-b border-slate-200 dark:border-slate-800"
    >
      <div
        class="max-w-6xl mx-auto px-3 sm:px-4 py-2.5 flex items-center gap-2"
      >
        <span
          class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-cyan-50 dark:bg-cyan-900/40 border border-cyan-100 dark:border-cyan-800 text-cyan-900 dark:text-cyan-100 font-extrabold"
        >
          📖 <span class="hidden xs:inline">LeerKids</span>
          <span
            class="text-[11px] font-black bg-sky-100 dark:bg-sky-900/40 border border-sky-200 dark:border-sky-800 rounded-full px-2 py-[2px]"
            >MVP</span
          >
        </span>

        <div class="text-sm text-slate-600 dark:text-slate-300 hidden sm:block">
          Aprende a leer en español
        </div>

        <div class="ml-auto flex items-center gap-1 sm:gap-2">
          <button
            id="btnReset"
            class="px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-700 font-bold hidden sm:inline-flex"
          >
            Reiniciar
          </button>
          <button
            id="btnResetSm"
            class="sm:hidden inline-flex items-center justify-center w-10 h-10 rounded-xl border border-slate-200 dark:border-slate-700"
            title="Reiniciar"
          >
            ↻
          </button>

          <!-- Toggle de tema -->
          <button
            id="btnTheme"
            class="inline-flex items-center justify-center w-10 h-10 rounded-xl border border-slate-200 dark:border-slate-700"
            title="Cambiar tema"
            aria-label="Cambiar tema"
          >
            🌙
          </button>

          <label
            class="flex items-center gap-1 text-sm px-2 py-1 rounded-xl border border-slate-200 dark:border-slate-700"
          >
            <span aria-hidden="true">🔊</span>
            <input
              id="toggleAudio"
              type="checkbox"
              class="accent-emerald-600"
              checked
              aria-label="Audio"
            />
            <span class="hidden sm:inline">Audio</span>
          </label>
        </div>
      </div>
    </header>

    <!-- Main -->
    <main class="max-w-6xl mx-auto px-3 sm:px-4 py-4">
      <!-- HOME: catálogo en acordeón -->
      <section id="home" class="space-y-4">
        <div
          class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-2xl shadow-sm p-4"
        >
          <h1 class="text-2xl font-extrabold">¡Vamos a leer!</h1>
          <p class="text-sm text-slate-600 dark:text-slate-300">
            Módulos: vocales → sílabas → palabras → frases → juegos.
          </p>
        </div>

        <!-- Catálogo por categorías (acordeón) -->
        <div id="catalog" class="space-y-3"></div>
      </section>

      <!-- Lesson View -->
      <section
        id="lessonView"
        class="hidden bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-2xl shadow-sm p-4 mt-4"
        role="region"
        aria-label="Actividad de la lección"
      >
        <div class="flex items-center gap-3 flex-wrap">
          <button
            id="btnBack"
            class="px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-700 font-bold"
          >
            ← Volver
          </button>
          <div id="lessonTitle" class="font-extrabold"></div>
          <div class="text-amber-500 font-black">
            ⭐ <span id="starCount">0</span>
          </div>
        </div>
        <div
          class="h-3 bg-slate-200 dark:bg-slate-700 rounded-full overflow-hidden mt-2"
        >
          <div
            id="progressBar"
            class="h-3 bg-gradient-to-r from-emerald-500 to-sky-500 w-0"
          ></div>
        </div>
        <div id="activity" class="mt-3"></div>
        <div class="flex items-center gap-2 mt-3">
          <button
            id="btnRepeat"
            class="px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-700"
          >
            🔊 Repetir
          </button>
          <button
            id="btnNext"
            class="btn-next px-3 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white font-extrabold"
          >
            Siguiente ▷
          </button>
        </div>
      </section>
    </main>

    <!-- Toast -->
    <div
      id="toast"
      class="fixed bottom-4 right-4 bg-slate-900 text-white px-3 py-2 rounded-xl shadow-lg opacity-0 translate-y-2 transition"
    ></div>

    <script>
      /* ========= Tema Light/Dark (persistente) ========= */
      const THEME_KEY = "leerkids-theme";
      function getStoredTheme() {
        return localStorage.getItem(THEME_KEY) || "light"; // light por defecto
      }
      function applyTheme(theme) {
        const isDark = theme === "dark";
        document.documentElement.classList.toggle("dark", isDark);
        // icono
        const btn = document.getElementById("btnTheme");
        if (btn) btn.textContent = isDark ? "☀️" : "🌙";
        localStorage.setItem(THEME_KEY, theme);
      }
      function toggleTheme() {
        const cur = getStoredTheme();
        applyTheme(cur === "dark" ? "light" : "dark");
      }
      // Aplica el tema lo antes posible (antes de pintar)
      (function initTheme() {
        applyTheme(getStoredTheme());
      })();

      /* ========= Carga de lecciones desde lessons.js ========= */
      let LESSONS = [];
      (function initLessonsFromJS() {
        if (
          !Array.isArray(window.LEERKIDS_LESSONS) ||
          !window.LEERKIDS_LESSONS.length
        ) {
          alert(
            "No se encontró lessons.js o está vacío. Asegúrate de poner lessons.js junto a index.html."
          );
          window.LEERKIDS_LESSONS = [];
        }
        LESSONS = window.LEERKIDS_LESSONS.map((ls) => {
          let fn = (t) => t;
          if (ls.speakText === "lower") fn = (t) => String(t).toLowerCase();
          else if (ls.speakText === "x" || ls.speakText == null) fn = (t) => t;
          return { ...ls, speakText: fn };
        });
      })();

      /* ========= Estado / utilidades ========= */
      const STORAGE_KEY = "leerkids-progress-v1";
      const state = {
        current: null,
        index: 0,
        stars: 0,
        audioOn: true,
        audioPlayer: null,
        audioMissing: new Set(),
        cacheVoices: [],
        canAdvance: false,
        balloon: {
          timer: null,
          cleanup: [],
          collected: 0,
          goal: 0,
          target: "",
          spawnMs: 650,
        },
      };
      function loadProgress() {
        try {
          return JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
        } catch {
          return {};
        }
      }
      function saveProgress(p) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(p));
      }
      function getLessonProgress(id) {
        const p = loadProgress();
        return p[id] || { done: 0, stars: 0 };
      }
      function setLessonProgress(id, data) {
        const p = loadProgress();
        p[id] = { ...getLessonProgress(id), ...data };
        saveProgress(p);
      }
      const AUDIO_BASE_PATH = "audio";
      const AUDIO_EXTENSION = ".wav";
      function ensureVoices() {
        if (typeof speechSynthesis === "undefined") return;
        const load = () => {
          try {
            state.cacheVoices = speechSynthesis.getVoices();
          } catch {
            state.cacheVoices = [];
          }
        };
        try {
          speechSynthesis.addEventListener("voiceschanged", load);
        } catch {}
        load();
      }
      function normalizeAudioKey(text) {
        return String(text || "")
          .toLowerCase()
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "")
          .replace(/[^a-z0-9]+/g, "_")
          .replace(/^_+|_+$/g, "");
      }
      function stopCurrentAudio() {
        if (state.audioPlayer) {
          try {
            state.audioPlayer.pause();
            state.audioPlayer.currentTime = 0;
          } catch {}
          state.audioPlayer = null;
        }
      }
      function speakWithTTS(text) {
        if (!state.audioOn) return;
        if (
          typeof speechSynthesis === "undefined" ||
          typeof SpeechSynthesisUtterance === "undefined"
        )
          return;
        try {
          speechSynthesis.cancel();
          const u = new SpeechSynthesisUtterance(text);
          const voices = state.cacheVoices.length
            ? state.cacheVoices
            : speechSynthesis.getVoices();
          const v =
            voices.find((voice) => /^(es-|es|es_)/i.test(voice.lang)) ||
            voices[0];
          if (v) u.voice = v;
          u.rate = 0.95;
          u.pitch = 1;
          u.lang = v?.lang || "es-ES";
          speechSynthesis.speak(u);
        } catch (e) {
          console.warn("No TTS:", e);
        }
      }
      function speak(text) {
        if (!state.audioOn) return;
        const phrase = String(text || "").trim();
        if (!phrase) return;
        try {
          if (typeof speechSynthesis !== "undefined") {
            speechSynthesis.cancel();
          }
        } catch {}
        stopCurrentAudio();
        const key = normalizeAudioKey(phrase);
        if (key && !state.audioMissing.has(key)) {
          const src = `${AUDIO_BASE_PATH}/${key}${AUDIO_EXTENSION}`;
          const audio = new Audio(src);
          state.audioPlayer = audio;
          let didFallback = false;
          const fallback = (markMissing) => {
            if (didFallback) return;
            didFallback = true;
            if (markMissing) {
              state.audioMissing.add(key);
            }
            if (state.audioPlayer === audio) {
              state.audioPlayer = null;
            }
            speakWithTTS(phrase);
          };
          audio.addEventListener(
            "error",
            () => {
              fallback(true);
            },
            { once: true }
          );
          audio.addEventListener(
            "ended",
            () => {
              if (state.audioPlayer === audio) {
                state.audioPlayer = null;
              }
            },
            { once: true }
          );
          try {
            const playPromise = audio.play();
            if (playPromise && typeof playPromise.catch === "function") {
              playPromise.catch(() => fallback(false));
            }
          } catch (e) {
            fallback(false);
          }
          return;
        }
        speakWithTTS(phrase);
      }
      function toast(msg) {
        const el = $("#toast");
        el.text(msg)
          .removeClass("opacity-0 translate-y-2")
          .addClass("opacity-100 translate-y-0");
        setTimeout(
          () =>
            el
              .addClass("opacity-0 translate-y-2")
              .removeClass("opacity-100 translate-y-0"),
          1400
        );
      }
      const shuffle = (a) =>
        a
          .map((v) => [Math.random(), v])
          .sort((x, y) => x[0] - y[0])
          .map((x) => x[1]);
      function setNextEnabled(ok) {
        state.canAdvance = !!ok;
        $("#btnNext").prop("disabled", !ok);
      }

      /* ========= Acordeón: solo 1 <details> abierto ========= */
      document.addEventListener(
        "toggle",
        function (e) {
          const el = e.target;
          if (
            el.tagName === "DETAILS" &&
            el.dataset.acc === "home" &&
            el.open
          ) {
            document
              .querySelectorAll('details[data-acc="home"]')
              .forEach((d) => {
                if (d !== el) d.open = false;
              });
          }
        },
        true
      );

      /* ========= UI: Catálogo por categoría (home) ========= */
      function groupByCategory(lessons) {
        const map = {};
        for (const ls of lessons) {
          const cat = ls.category || "General";
          (map[cat] ||= []).push(ls);
        }
        return map;
      }

      function renderCatalog() {
        const $root = $("#catalog").empty();
        const groups = groupByCategory(LESSONS);

        Object.keys(groups)
          .sort()
          .forEach((cat, i) => {
            const $details = $(`
          <details data-acc="home" class="border border-slate-200 dark:border-slate-700 rounded-2xl bg-white dark:bg-slate-800 shadow-sm">
            <summary class="flex items-center gap-2 px-3 py-3 cursor-pointer select-none">
              <span class="i-chevron w-5 h-5 inline-flex items-center justify-center">▸</span>
              <span class="font-extrabold text-base sm:text-lg">${cat}</span>
            </summary>
            <div class="p-3">
              <!-- BOTONES GRANDES / TOCABLES -->
              <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-3" data-grid></div>
            </div>
          </details>
        `);

            // Flecha ▸/▾
            $details.on("toggle", function () {
              $(this)
                .find(".i-chevron")
                .text(this.open ? "▾" : "▸");
            });

            const $grid = $details.find("[data-grid]");

            // Tarjetas grandes tipo "shortcut" (tocables)
            groups[cat].forEach((ls) => {
              let big = "📚";
              if (ls.kind === "choice-sound") {
                big =
                  (ls.pool?.[0] || "") +
                  (ls.pool?.[1] ? " • " + ls.pool[1] : "");
              } else if (ls.kind === "picture-pick") {
                big = ls.pool?.[0]?.emoji || "🖼️";
              } else if (ls.kind === "build-phrase") {
                big = "🧩";
              } else if (ls.kind === "balloon-hunt") {
                big = "🎈";
              }

              const $btn = $(`
            <button
              class="flex flex-col items-center justify-center gap-1 p-4 h-28 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-2xl shadow-sm hover:shadow transition text-center"
              data-jump="${ls.id}"
            >
              <span class="text-xl font-extrabold">${big}</span>
              <span class="text-xs sm:text-sm font-extrabold text-slate-800 dark:text-slate-100 break-words">${ls.title}</span>
            </button>
          `);
              $grid.append($btn);
            });

            $root.append($details);
          });
      }

      /* ========= Flujo de lección ========= */
      function startLesson(id) {
        stopBalloonGame();
        state.current = LESSONS.find((x) => x.id === id);
        state.index = 0;
        state.stars = getLessonProgress(id).stars || 0;
        $("#home").addClass("hidden");
        $("#lessonView").removeClass("hidden");
        $("#lessonTitle").text(state.current.title);
        $("#starCount").text(state.stars);
        renderStep();
      }

      function renderStep() {
        const ls = state.current;
        if (!ls) return;
        const total = ls.items.length;
        $("#progressBar").css("width", (state.index / total) * 100 + "%");
        const item = ls.items[state.index];
        setNextEnabled(false);

        if (ls.kind === "choice-sound") {
          const opts = shuffle(ls.pool).slice(0, 4);
          if (!opts.includes(item)) {
            opts[Math.floor(Math.random() * opts.length)] = item;
          }
          $("#activity").html(
            '<div class="text-sm text-slate-600 dark:text-slate-300">' +
              ls.prompt +
              '</div>\
           <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mt-3">' +
              opts
                .map(
                  (o) =>
                    '<div class="flex items-center justify-center h-20 text-2xl font-black bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-2xl cursor-pointer" data-val="' +
                    o +
                    '">' +
                    o +
                    "</div>"
                )
                .join("") +
              "</div>"
          );
          const say = ls.speakText(item);
          const play = () => speak(say);
          $("#btnRepeat").off().on("click", play);
          setTimeout(play, 200);
          $("#activity [data-val]").on("click", function () {
            const val = $(this).data("val");
            const $g = $(this).closest('[class*="grid"]');
            $g.find("[data-val]").removeClass(
              "ring-2 ring-red-400 ring-emerald-400"
            );
            const correct = val === item;
            $(this).addClass(
              correct ? "ring-2 ring-emerald-400" : "ring-2 ring-red-400"
            );
            if (correct) {
              speak("¡Muy bien!");
              state.stars++;
              $("#starCount").text(state.stars);
              setLessonProgress(ls.id, { stars: state.stars });
              setNextEnabled(true);
            } else {
              speak("Intenta de nuevo");
              setNextEnabled(false);
            }
          });
        } else if (ls.kind === "picture-pick") {
          const opts = shuffle(ls.pool).slice(0, 4);
          const needle = ls.pool.find((p) => p.w === item) || opts[0];
          if (!opts.some((x) => x.w === item)) {
            opts[Math.floor(Math.random() * opts.length)] = needle;
          }
          $("#activity").html(
            '<div class="text-sm text-slate-600 dark:text-slate-300">' +
              ls.prompt +
              '</div>\
           <div class="flex items-center justify-center h-24 text-6xl">' +
              needle.emoji +
              '</div>\
           <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mt-3">' +
              opts
                .map(
                  (o) =>
                    '<div class="flex items-center justify-center h-16 text-xl font-black bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-2xl cursor-pointer" data-val="' +
                    o.w +
                    '">' +
                    o.w +
                    "</div>"
                )
                .join("") +
              "</div>"
          );
          const say = needle.w.toLowerCase();
          const play = () => speak(say);
          $("#btnRepeat").off().on("click", play);
          setTimeout(play, 200);
          $("#activity [data-val]").on("click", function () {
            const val = $(this).data("val");
            const $g = $(this).closest('[class*="grid"]');
            $g.find("[data-val]").removeClass(
              "ring-2 ring-red-400 ring-emerald-400"
            );
            const correct = val === item;
            $(this).addClass(
              correct ? "ring-2 ring-emerald-400" : "ring-2 ring-red-400"
            );
            if (correct) {
              speak("¡Muy bien!");
              state.stars++;
              $("#starCount").text(state.stars);
              setLessonProgress(ls.id, { stars: state.stars });
              setNextEnabled(true);
            } else {
              speak("Intenta de nuevo");
              setNextEnabled(false);
            }
          });
        } else if (ls.kind === "build-phrase") {
          const entry = ls.pool[item];
          const parts = shuffle(entry.parts.slice());
          $("#activity").html(
            '<div class="text-sm text-slate-600 dark:text-slate-300">' +
              ls.prompt +
              '</div>\
           <div id="drop" class="min-h-[84px] bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-2xl p-3 mt-2 flex flex-wrap gap-2"></div>\
           <div id="phraseBank" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-3 mt-3">' +
              parts
                .map(
                  (p, i) =>
                    '<button class="word-btn bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-base sm:text-lg cursor-pointer" data-word="' +
                    p +
                    '" data-idx="' +
                    i +
                    '">' +
                    p +
                    "</button>"
                )
                .join("") +
              "</div>"
          );
          const speakPhrase = () => speak(entry.phrase.toLowerCase());
          $("#btnRepeat").off().on("click", speakPhrase);
          setTimeout(speakPhrase, 200);
          const checkOK = () => {
            const built = $("#drop [data-part]")
              .map((i, el) => $(el).data("part"))
              .get();
            const ok = built.join(" ") === entry.parts.join(" ");
            setNextEnabled(ok);
            return ok;
          };
          $("#phraseBank [data-word]").on("click", function () {
            if ($(this).prop("disabled")) return;
            const w = $(this).data("word"),
              idx = $(this).data("idx");
            $(this)
              .prop("disabled", true)
              .addClass("opacity-50 cursor-not-allowed");
            $("#drop").append(
              '<span class="drop-pill bg-sky-50 dark:bg-sky-900/30 border border-sky-200 dark:border-sky-800 text-base sm:text-lg" data-part="' +
                w +
                '" data-idx="' +
                idx +
                '" title="Quitar">' +
                w +
                "</span>"
            );
            checkOK();
          });
          $("#drop")
            .off()
            .on("click", "[data-idx]", function () {
              const idx = $(this).data("idx");
              $(this).remove();
              const $b = $('#phraseBank [data-idx="' + idx + '"]');
              $b.prop("disabled", false).removeClass(
                "opacity-50 cursor-not-allowed"
              );
              checkOK();
            });
        } else if (ls.kind === "balloon-hunt") {
          startBalloonGame(ls, item);
          setNextEnabled(false);
        }
      }

      function nextStep() {
        const ls = state.current;
        if (!ls) return;
        if (!state.canAdvance) {
          speak("Primero completa este paso");
          toast("Primero completa este paso");
          return;
        }
        if (ls.kind === "balloon-hunt") {
          stopBalloonGame();
        }
        state.index++;
        const total = state.current.items.length;
        setLessonProgress(state.current.id, {
          done: Math.max(getLessonProgress(ls.id).done, state.index),
        });
        if (state.index >= total) {
          $("#progressBar").css("width", "100%");
          speak("¡Excelente! Lección completa.");
          toast("Lección completa ✨");
          $("#lessonView").addClass("hidden");
          $("#home").removeClass("hidden");
          renderCatalog();
        } else {
          renderStep();
        }
      }

      /* ========= Globos ========= */
      const BAL_COLORS = [
        "bg-rose-500",
        "bg-red-500",
        "bg-orange-500",
        "bg-amber-500",
        "bg-emerald-500",
        "bg-teal-500",
        "bg-sky-500",
        "bg-blue-500",
        "bg-violet-500",
        "bg-fuchsia-500",
      ];
      function startBalloonGame(ls, item) {
        stopBalloonGame();
        const goal = ls.goal || 10;
        state.balloon.collected = 0;
        state.balloon.goal = goal;
        state.balloon.target = item;
        const promptText = `${ls.prompt} ${item}. Toca ${goal}.`;
        $("#activity").html(
          '<div class="text-sm text-slate-600 dark:text-slate-300">' +
            promptText +
            '</div>\
         <div class="flex items-center gap-2 mt-2 text-sm">\
           <span class="font-extrabold">Objetivo:</span> <span class="px-2 py-1 rounded-full bg-emerald-50 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-200 border border-emerald-200 dark:border-emerald-800">' +
            item +
            '</span>\
           <span class="ml-2 font-extrabold">Llevas:</span> <span id="balloonCount" class="px-2 py-1 rounded-full bg-slate-100 dark:bg-slate-700 border border-slate-200 dark:border-slate-600">0/' +
            goal +
            '</span>\
         </div>\
         <div id="balloonArea" class="relative overflow-hidden bg-gradient-to-t from-sky-50 to-white dark:from-slate-800 dark:to-slate-900 border border-slate-200 dark:border-slate-700 rounded-2xl mt-3" style="height:360px;cursor:pointer;"></div>'
        );
        const say = () => {
          speak("Toca todos los globos con la letra");
          setTimeout(() => speak(item), 240);
        };
        $("#btnRepeat").off().on("click", say);
        setTimeout(say, 120);
        const $area = $("#balloonArea");
        const spawn = () => spawnBalloon($area, ls.pool, item);
        state.balloon.timer = setInterval(() => {
          if (state.balloon.collected >= state.balloon.goal) {
            stopBalloonGame();
            return;
          }
          spawn();
        }, state.balloon.spawnMs);
        state.balloon.cleanup.push(() => {
          $area.find(".balloon").remove();
        });
      }
      function stopBalloonGame() {
        if (state.balloon.timer) {
          clearInterval(state.balloon.timer);
          state.balloon.timer = null;
        }
        (state.balloon.cleanup || []).forEach((fn) => {
          try {
            fn();
          } catch {}
        });
        state.balloon.cleanup = [];
      }
      function spawnBalloon($area, pool, target) {
        const isTarget = Math.random() < 0.45;
        const letter = isTarget
          ? target
          : shuffle(pool.filter((l) => l !== target))[0] || target;
        const leftPct = Math.floor(6 + Math.random() * 88);
        const dur = (3 + Math.random() * 2.2).toFixed(2) + "s";
        const color = BAL_COLORS[Math.floor(Math.random() * BAL_COLORS.length)];
        const $b = $('<div class="balloon ' + color + '"></div>');
        $b.css({ left: leftPct + "%", bottom: "-80px", "--dur": dur })
          .attr("data-letter", letter)
          .text(letter);
        $b.on("animationend", function () {
          $(this).remove();
        });
        $b.on("pointerdown", function (e) {
          e.preventDefault();
          const val = $(this).attr("data-letter");
          if ($(this).hasClass("pop")) return;
          const ok = val === target;
          if (ok) {
            $(this).addClass("ring-2 ring-emerald-300 pop");
            state.stars++;
            $("#starCount").text(state.stars);
            setLessonProgress(state.current.id, { stars: state.stars });
            state.balloon.collected++;
            $("#balloonCount").text(
              state.balloon.collected + "/" + state.balloon.goal
            );
            speak("¡Bien!");
            setTimeout(() => $(this).remove(), 150);
            if (state.balloon.collected >= state.balloon.goal) {
              toast("¡Meta alcanzada! Pulsa Siguiente");
              speak("¡Meta alcanzada!");
              stopBalloonGame();
              setNextEnabled(true);
            }
          } else {
            $(this).addClass("ring-2 ring-red-400");
            speak("No");
            setTimeout(() => $(this).removeClass("ring-2 ring-red-400"), 300);
          }
        });
        $area.append($b);
      }

      /* ========= Eventos globales ========= */
      $(function () {
        // Botón de tema
        $("#btnTheme").on("click", toggleTheme);

        ensureVoices();
        renderCatalog();

        $(document).on("click", "[data-jump]", function () {
          startLesson($(this).data("jump"));
        });
        $("#btnBack").on("click", () => {
          stopBalloonGame();
          $("#lessonView").addClass("hidden");
          $("#home").removeClass("hidden");
        });
        $("#btnNext").on("click", nextStep);
        $("#btnRepeat").on("click", () => {});
        $("#toggleAudio").on("change", function () {
          state.audioOn = this.checked;
          if (!this.checked) {
            stopCurrentAudio();
            try {
              if (typeof speechSynthesis !== "undefined") {
                speechSynthesis.cancel();
              }
            } catch {}
          }
          toast(this.checked ? "Audio activado" : "Audio desactivado");
        });
        const doReset = () => {
          if (confirm("¿Borrar progreso?")) {
            localStorage.removeItem(STORAGE_KEY);
            toast("Progreso borrado");
            renderCatalog();
          }
        };
        $("#btnReset, #btnResetSm").on("click", doReset);
      });
    </script>
  </body>
</html>
