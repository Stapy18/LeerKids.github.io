<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>LeerKids ‚Äî Aprende a leer (ES)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap"
      rel="stylesheet"
    />
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <style>
      html,
      body {
        font-family: "Nunito", system-ui, -apple-system, Segoe UI, Roboto;
      }
      .clamp-2 {
        display: -webkit-box;
        -webkit-box-orient: vertical;
        overflow: hidden;
        -webkit-line-clamp: 2;
      }
      /* Globos */
      @keyframes float-up {
        0% {
          transform: translateY(110%);
          opacity: 0;
        }
        8% {
          opacity: 1;
        }
        100% {
          transform: translateY(-600%);
          opacity: 0;
        }
      }
      .balloon {
        position: absolute;
        width: 68px;
        height: 68px;
        border-radius: 9999px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 900;
        box-shadow: 0 10px 22px rgba(15, 23, 42, 0.18);
        animation: float-up var(--dur, 4s) linear forwards;
        user-select: none;
        -webkit-user-select: none;
        color: #fff;
        text-shadow: 0 1px 1px rgba(0, 0, 0, 0.25),
          0 2px 6px rgba(0, 0, 0, 0.25);
      }
      .balloon::after {
        content: "";
        position: absolute;
        bottom: -8px;
        left: 50%;
        transform: translateX(-50%);
        width: 0;
        height: 0;
        border-left: 6px solid transparent;
        border-right: 6px solid transparent;
        border-top: 10px solid rgba(0, 0, 0, 0.25);
      }
      .balloon.pop {
        transform: scale(0.6);
        opacity: 0.1;
        transition: 0.25s ease;
      }
      /* Palabras/frases */
      .word-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 3.5rem;
        border-radius: 1rem;
        font-weight: 900;
      }
      @media (min-width: 640px) {
        .word-btn {
          height: 4rem;
        }
      }
      .drop-pill {
        display: inline-flex;
        align-items: center;
        height: 2.75rem;
        padding: 0 0.75rem;
        border-radius: 9999px;
        font-weight: 800;
        cursor: pointer;
      }
      .btn-next[disabled] {
        opacity: 0.5;
        cursor: not-allowed;
      }
    </style>

    <!-- Carga SOLO el archivo JS de lecciones -->
    <script src="lessons.js"></script>
  </head>
  <body class="bg-slate-50 text-slate-900">
    <!-- Header compacto en m√≥viles -->
    <header
      class="sticky top-0 z-40 bg-white/90 backdrop-blur border-b border-slate-200"
    >
      <div
        class="max-w-6xl mx-auto px-3 sm:px-4 py-2.5 flex items-center gap-2"
      >
        <button
          id="toggleMenu"
          class="md:hidden inline-flex items-center justify-center w-10 h-10 rounded-xl border border-slate-200 text-slate-700"
          title="Abrir/cerrar lecciones"
        >
          ‚ò∞
        </button>
        <span
          class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-cyan-50 border border-cyan-100 text-cyan-900 font-extrabold"
        >
          üìñ <span class="hidden xs:inline">LeerKids</span>
          <span
            class="text-[11px] font-black bg-sky-100 border border-sky-200 rounded-full px-2 py-[2px]"
            >MVP</span
          >
        </span>
        <div class="text-sm text-slate-600 hidden sm:block">
          Aprende a leer en espa√±ol
        </div>
        <div class="ml-auto flex items-center gap-1 sm:gap-2">
          <button
            id="btnReset"
            class="px-3 py-2 rounded-xl border border-slate-200 font-bold hidden sm:inline-flex"
          >
            Reiniciar
          </button>
          <button
            id="btnResetSm"
            class="sm:hidden inline-flex items-center justify-center w-10 h-10 rounded-xl border border-slate-200"
            title="Reiniciar"
          >
            ‚Üª
          </button>
          <label
            class="flex items-center gap-1 text-sm px-2 py-1 rounded-xl border border-slate-200"
          >
            <span aria-hidden="true">üîä</span>
            <input
              id="toggleAudio"
              type="checkbox"
              class="accent-emerald-600"
              checked
              aria-label="Audio"
            />
            <span class="hidden sm:inline">Audio</span>
          </label>
        </div>
      </div>
    </header>

    <!-- Layout -->
    <main class="max-w-6xl mx-auto px-3 sm:px-4 py-4">
      <div class="grid grid-cols-1 md:grid-cols-[280px_minmax(0,1fr)] gap-4">
        <!-- Sidebar -->
        <aside
          id="sidebar"
          class="md:sticky md:top-20 h-max bg-white border border-slate-200 rounded-2xl shadow-sm p-3 hidden md:block"
        >
          <div class="flex items-center justify-between mb-2">
            <h2 class="font-extrabold text-lg">Lecciones</h2>
          </div>
          <div id="lessonList" class="space-y-3" role="list"></div>
        </aside>

        <!-- Main -->
        <section class="space-y-4">
          <div
            id="home"
            class="bg-white border border-slate-200 rounded-2xl shadow-sm p-4"
          >
            <h1 class="text-2xl font-extrabold">¬°Vamos a leer!</h1>
            <p class="text-sm text-slate-600">
              M√≥dulos: vocales ‚Üí s√≠labas ‚Üí palabras ‚Üí frases.
            </p>
            <div
              id="homeShortcuts"
              class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-3 mt-3"
            ></div>
          </div>

          <div
            id="lessonView"
            class="hidden bg-white border border-slate-200 rounded-2xl shadow-sm p-4"
            role="region"
            aria-label="Actividad de la lecci√≥n"
          >
            <div class="flex items-center gap-3 flex-wrap">
              <button
                id="btnBack"
                class="px-3 py-2 rounded-xl border border-slate-200 font-bold"
              >
                ‚Üê Volver
              </button>
              <div id="lessonTitle" class="font-extrabold"></div>
              <div class="text-amber-500 font-black">
                ‚≠ê <span id="starCount">0</span>
              </div>
            </div>
            <div class="h-3 bg-slate-200 rounded-full overflow-hidden mt-2">
              <div
                id="progressBar"
                class="h-3 bg-gradient-to-r from-emerald-500 to-sky-500 w-0"
              ></div>
            </div>
            <div id="activity" class="mt-3"></div>
            <div class="flex items-center gap-2 mt-3">
              <button
                id="btnRepeat"
                class="px-3 py-2 rounded-xl border border-slate-200"
              >
                üîä Repetir
              </button>
              <button
                id="btnNext"
                class="btn-next px-3 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white font-extrabold"
              >
                Siguiente ‚ñ∑
              </button>
            </div>
          </div>
        </section>
      </div>
    </main>

    <div
      id="toast"
      class="fixed bottom-4 right-4 bg-slate-900 text-white px-3 py-2 rounded-xl shadow-lg opacity-0 translate-y-2 transition"
    ></div>

    <script>
      /* ========= Carga de lecciones SOLO desde lessons.js ========= */
      let LESSONS = [];
      (function initLessonsFromJS() {
        if (
          !Array.isArray(window.LEERKIDS_LESSONS) ||
          !window.LEERKIDS_LESSONS.length
        ) {
          alert(
            "No se encontr√≥ lessons.js o est√° vac√≠o. Aseg√∫rate de poner lessons.js junto a index.html."
          );
          window.LEERKIDS_LESSONS = [];
        }
        LESSONS = window.LEERKIDS_LESSONS.map((ls) => {
          // Normaliza speakText: acepta "lower" o "x"
          let fn = (t) => t;
          if (ls.speakText === "lower") fn = (t) => String(t).toLowerCase();
          else if (ls.speakText === "x" || ls.speakText == null) fn = (t) => t;
          return { ...ls, speakText: fn };
        });
      })();

      /* ========= Estado / utilidades ========= */
      const STORAGE_KEY = "leerkids-progress-v1";
      const state = {
        current: null,
        index: 0,
        stars: 0,
        audioOn: true,
        cacheVoices: [],
        canAdvance: false,
        balloon: {
          timer: null,
          cleanup: [],
          collected: 0,
          goal: 0,
          target: "",
          spawnMs: 650,
        },
      };
      function loadProgress() {
        try {
          return JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
        } catch {
          return {};
        }
      }
      function saveProgress(p) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(p));
      }
      function getLessonProgress(id) {
        const p = loadProgress();
        return p[id] || { done: 0, stars: 0 };
      }
      function setLessonProgress(id, data) {
        const p = loadProgress();
        p[id] = { ...getLessonProgress(id), ...data };
        saveProgress(p);
      }
      function ensureVoices() {
        const load = () => {
          state.cacheVoices = speechSynthesis.getVoices();
        };
        speechSynthesis.addEventListener("voiceschanged", load);
        load();
      }
      function speak(text) {
        if (!state.audioOn) return;
        try {
          speechSynthesis.cancel();
          const u = new SpeechSynthesisUtterance(text);
          const voices = state.cacheVoices.length
            ? state.cacheVoices
            : speechSynthesis.getVoices();
          const v =
            voices.find((v) => /^(es-|es|es_)/i.test(v.lang)) || voices[0];
          if (v) u.voice = v;
          u.rate = 0.95;
          u.pitch = 1;
          u.lang = v?.lang || "es-ES";
          speechSynthesis.speak(u);
        } catch (e) {
          console.warn("No TTS:", e);
        }
      }
      function toast(msg) {
        const el = $("#toast");
        el.text(msg)
          .removeClass("opacity-0 translate-y-2")
          .addClass("opacity-100 translate-y-0");
        setTimeout(
          () =>
            el
              .addClass("opacity-0 translate-y-2")
              .removeClass("opacity-100 translate-y-0"),
          1400
        );
      }
      const shuffle = (a) =>
        a
          .map((v) => [Math.random(), v])
          .sort((x, y) => x[0] - y[0])
          .map((x) => x[1]);
      function setNextEnabled(ok) {
        state.canAdvance = !!ok;
        $("#btnNext").prop("disabled", !ok);
      }

      /* ========= Agrupar por categor√≠a / subcategor√≠a ========= */
      function groupByCategory(lessons) {
        const catMap = {};
        for (const ls of lessons) {
          const cat = ls.category || "General";
          const sub = ls.subcategory || null;
          catMap[cat] = catMap[cat] || {};
          if (sub) {
            catMap[cat][sub] = catMap[cat][sub] || [];
            catMap[cat][sub].push(ls);
          } else {
            catMap[cat]._root = catMap[cat]._root || [];
            catMap[cat]._root.push(ls);
          }
        }
        return catMap;
      }

      /* ========= UI: Sidebar / Home ========= */
      function renderLessonList() {
        const $list = $("#lessonList").empty();
        const groups = groupByCategory(LESSONS);

        Object.keys(groups)
          .sort()
          .forEach((cat) => {
            const $cat = $(
              '<details open class="border border-slate-200 rounded-xl overflow-hidden bg-white"></details>'
            );
            const $summary = $(
              '<summary class="cursor-pointer select-none px-3 py-2 font-extrabold bg-slate-50 border-b border-slate-200 text-slate-800 flex items-center justify-between"></summary>'
            );
            $summary.append("<span>" + cat + "</span>");
            $summary.append(
              '<span class="text-slate-500 text-xs">toca para contraer</span>'
            );
            $cat.append($summary);

            const $container = $('<div class="p-2 space-y-2"></div>');

            // Lecciones sin subcategor√≠a
            const root = groups[cat]._root || [];
            root.forEach((ls) => $container.append(lessonItem(ls)));

            // Subcategor√≠as
            Object.keys(groups[cat])
              .filter((k) => k !== "_root")
              .sort()
              .forEach((sub) => {
                const $sub = $('<div class="mt-2"></div>');
                $sub.append(
                  '<div class="text-xs font-black uppercase tracking-wide text-slate-500 px-2 mb-1">' +
                    sub +
                    "</div>"
                );
                groups[cat][sub].forEach((ls) => $sub.append(lessonItem(ls)));
                $container.append($sub);
              });

            $cat.append($container);
            $list.append($cat);
          });
      }

      function lessonItem(ls) {
        const prog = getLessonProgress(ls.id);
        const isDone = (prog.done || 0) >= ls.items.length;
        const $card = $(
          '<div class="flex items-center justify-between gap-2 p-3 border border-slate-200 rounded-xl hover:bg-slate-50 cursor-pointer" tabindex="0" role="button" data-id="' +
            ls.id +
            '">\
        <div class="min-w-0">\
          <div class="font-extrabold">' +
            ls.title +
            '</div>\
          <div class="text-xs text-slate-600">Completado: ' +
            Math.min(prog.done || 0, ls.items.length) +
            "/" +
            ls.items.length +
            '</div>\
        </div>\
        <div class="inline-flex items-center justify-center gap-1 min-w-[92px] px-2 py-1 text-xs rounded-full whitespace-nowrap tabular-nums ' +
            (isDone
              ? "bg-emerald-50 text-emerald-700 border border-emerald-200"
              : "bg-slate-100 text-slate-700 border border-slate-200") +
            '">' +
            (isDone ? "‚úÖ Completado" : "‚≠ê " + (prog.stars || 0)) +
            "</div>\
      </div>"
        );
        $card.on("click keypress", (e) => {
          if (e.type === "click" || e.key === "Enter") {
            startLesson(ls.id);
          }
        });
        return $card;
      }

      function shortTitle(s) {
        const base = (s || "").split("(")[0].trim();
        return base.length > 18 ? base.slice(0, 18) + "‚Ä¶" : base;
      }
      function renderHomeShortcuts() {
        const $grid = $("#homeShortcuts").empty();
        LESSONS.forEach((ls) => {
          let big = "üìö";
          if (ls.kind === "choice-sound") {
            big =
              (ls.pool?.[0] || "") + (ls.pool?.[1] ? " ‚Ä¢ " + ls.pool[1] : "");
          } else if (ls.kind === "picture-pick") {
            big = ls.pool?.[0]?.emoji || "üñºÔ∏è";
          } else if (ls.kind === "build-phrase") {
            big = "üß©";
          } else if (ls.kind === "balloon-hunt") {
            big = "üéà";
          }
          const $btn = $(
            '<button class="flex flex-col items-center justify-center gap-1 p-4 h-28 bg-white border border-slate-200 rounded-2xl shadow-sm hover:shadow transition" data-jump="' +
              ls.id +
              '">\
          <span class="text-xl font-extrabold">' +
              big +
              '</span>\
          <span class="text-xs text-slate-700 font-extrabold clamp-2">' +
              shortTitle(ls.title) +
              "</span>\
        </button>"
          );
          $grid.append($btn);
        });
      }

      /* ========= Flujo de lecci√≥n ========= */
      function startLesson(id) {
        stopBalloonGame();
        state.current = LESSONS.find((x) => x.id === id);
        state.index = 0;
        state.stars = getLessonProgress(id).stars || 0;
        $("#home").addClass("hidden");
        $("#lessonView").removeClass("hidden");
        $("#lessonTitle").text(state.current.title);
        $("#starCount").text(state.stars);
        renderStep();
        if (window.innerWidth < 768) {
          $("#sidebar").addClass("hidden");
        }
      }

      function renderStep() {
        const ls = state.current;
        if (!ls) return;
        const total = ls.items.length;
        $("#progressBar").css("width", (state.index / total) * 100 + "%");
        const item = ls.items[state.index];
        setNextEnabled(false);

        if (ls.kind === "choice-sound") {
          const opts = shuffle(ls.pool).slice(0, 4);
          if (!opts.includes(item)) {
            opts[Math.floor(Math.random() * opts.length)] = item;
          }
          $("#activity").html(
            '<div class="text-sm text-slate-600">' +
              ls.prompt +
              '</div>\
          <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mt-3">' +
              opts
                .map(
                  (o) =>
                    '<div class="flex items-center justify-center h-20 text-2xl font-black bg-white border border-slate-200 rounded-2xl cursor-pointer" data-val="' +
                    o +
                    '">' +
                    o +
                    "</div>"
                )
                .join("") +
              "</div>"
          );
          const say = ls.speakText(item);
          const play = () => speak(say);
          $("#btnRepeat").off().on("click", play);
          setTimeout(play, 200);
          $("#activity [data-val]").on("click", function () {
            const val = $(this).data("val");
            const $g = $(this).closest('[class*="grid"]');
            $g.find("[data-val]").removeClass(
              "ring-2 ring-red-400 ring-emerald-400"
            );
            const correct = val === item;
            $(this).addClass(
              correct ? "ring-2 ring-emerald-400" : "ring-2 ring-red-400"
            );
            if (correct) {
              speak("¬°Muy bien!");
              state.stars++;
              $("#starCount").text(state.stars);
              setLessonProgress(ls.id, { stars: state.stars });
              setNextEnabled(true);
            } else {
              speak("Intenta de nuevo");
              setNextEnabled(false);
            }
          });
        } else if (ls.kind === "picture-pick") {
          const opts = shuffle(ls.pool).slice(0, 4);
          const needle = ls.pool.find((p) => p.w === item) || opts[0];
          if (!opts.some((x) => x.w === item)) {
            opts[Math.floor(Math.random() * opts.length)] = needle;
          }
          $("#activity").html(
            '<div class="text-sm text-slate-600">' +
              ls.prompt +
              '</div>\
          <div class="flex items-center justify-center h-24 text-6xl">' +
              needle.emoji +
              '</div>\
          <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mt-3">' +
              opts
                .map(
                  (o) =>
                    '<div class="flex items-center justify-center h-16 text-xl font-black bg-white border border-slate-200 rounded-2xl cursor-pointer" data-val="' +
                    o.w +
                    '">' +
                    o.w +
                    "</div>"
                )
                .join("") +
              "</div>"
          );
          const say = needle.w.toLowerCase();
          const play = () => speak(say);
          $("#btnRepeat").off().on("click", play);
          setTimeout(play, 200);
          $("#activity [data-val]").on("click", function () {
            const val = $(this).data("val");
            const $g = $(this).closest('[class*="grid"]');
            $g.find("[data-val]").removeClass(
              "ring-2 ring-red-400 ring-emerald-400"
            );
            const correct = val === item;
            $(this).addClass(
              correct ? "ring-2 ring-emerald-400" : "ring-2 ring-red-400"
            );
            if (correct) {
              speak("¬°Muy bien!");
              state.stars++;
              $("#starCount").text(state.stars);
              setLessonProgress(ls.id, { stars: state.stars });
              setNextEnabled(true);
            } else {
              speak("Intenta de nuevo");
              setNextEnabled(false);
            }
          });
        } else if (ls.kind === "build-phrase") {
          const entry = ls.pool[item];
          const parts = shuffle(entry.parts.slice());
          $("#activity").html(
            '<div class="text-sm text-slate-600">' +
              ls.prompt +
              '</div>\
          <div id="drop" class="min-h-[84px] bg-white border border-slate-200 rounded-2xl p-3 mt-2 flex flex-wrap gap-2"></div>\
          <div id="phraseBank" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-3 mt-3">' +
              parts
                .map(
                  (p, i) =>
                    '<button class="word-btn bg-white border border-slate-200 text-base sm:text-lg cursor-pointer" data-word="' +
                    p +
                    '" data-idx="' +
                    i +
                    '">' +
                    p +
                    "</button>"
                )
                .join("") +
              "</div>"
          );
          const speakPhrase = () => speak(entry.phrase.toLowerCase());
          $("#btnRepeat").off().on("click", speakPhrase);
          setTimeout(speakPhrase, 200);
          function checkOK() {
            const built = $("#drop [data-part]")
              .map((i, el) => $(el).data("part"))
              .get();
            const ok = built.join(" ") === entry.parts.join(" ");
            setNextEnabled(ok);
            return ok;
          }
          $("#phraseBank [data-word]").on("click", function () {
            if ($(this).prop("disabled")) return;
            const w = $(this).data("word"),
              idx = $(this).data("idx");
            $(this)
              .prop("disabled", true)
              .addClass("opacity-50 cursor-not-allowed");
            $("#drop").append(
              '<span class="drop-pill bg-sky-50 border border-sky-200 text-base sm:text-lg" data-part="' +
                w +
                '" data-idx="' +
                idx +
                '" title="Quitar">' +
                w +
                "</span>"
            );
            checkOK();
          });
          $("#drop")
            .off()
            .on("click", "[data-idx]", function () {
              const idx = $(this).data("idx");
              $(this).remove();
              const $b = $('#phraseBank [data-idx="' + idx + '"]');
              $b.prop("disabled", false).removeClass(
                "opacity-50 cursor-not-allowed"
              );
              checkOK();
            });
        } else if (ls.kind === "balloon-hunt") {
          startBalloonGame(ls, item);
          setNextEnabled(false);
        }
      }

      function nextStep() {
        const ls = state.current;
        if (!ls) return;
        if (!state.canAdvance) {
          speak("Primero completa este paso");
          toast("Primero completa este paso");
          return;
        }
        if (ls.kind === "balloon-hunt") {
          stopBalloonGame();
        }
        state.index++;
        const total = state.current.items.length;
        setLessonProgress(state.current.id, {
          done: Math.max(getLessonProgress(ls.id).done, state.index),
        });
        if (state.index >= total) {
          $("#progressBar").css("width", "100%");
          speak("¬°Excelente! Lecci√≥n completa.");
          toast("Lecci√≥n completa ‚ú®");
          $("#lessonView").addClass("hidden");
          $("#home").removeClass("hidden");
          renderLessonList();
          renderHomeShortcuts();
        } else {
          renderStep();
        }
      }

      /* ========= Globos ========= */
      const BAL_COLORS = [
        "bg-rose-500",
        "bg-red-500",
        "bg-orange-500",
        "bg-amber-500",
        "bg-emerald-500",
        "bg-teal-500",
        "bg-sky-500",
        "bg-blue-500",
        "bg-violet-500",
        "bg-fuchsia-500",
      ];
      function startBalloonGame(ls, item) {
        stopBalloonGame();
        const goal = ls.goal || 10;
        state.balloon.collected = 0;
        state.balloon.goal = goal;
        state.balloon.target = item;
        const promptText = `${ls.prompt} ${item}. Toca ${goal}.`;
        $("#activity").html(
          '<div class="text-sm text-slate-600">' +
            promptText +
            '</div>\
        <div class="flex items-center gap-2 mt-2 text-sm">\
          <span class="font-extrabold">Objetivo:</span> <span class="px-2 py-1 rounded-full bg-emerald-50 text-emerald-700 border border-emerald-200">' +
            item +
            '</span>\
          <span class="ml-2 font-extrabold">Llevas:</span> <span id="balloonCount" class="px-2 py-1 rounded-full bg-slate-100 border border-slate-200">0/' +
            goal +
            '</span>\
        </div>\
        <div id="balloonArea" class="relative overflow-hidden bg-gradient-to-t from-sky-50 to-white border border-slate-200 rounded-2xl mt-3" style="height:360px;cursor:pointer;"></div>'
        );
        const say = () => {
          speak("Toca todos los globos con la letra");
          setTimeout(() => speak(item), 240);
        };
        $("#btnRepeat").off().on("click", say);
        setTimeout(say, 120);
        const $area = $("#balloonArea");
        const spawn = () => spawnBalloon($area, ls.pool, item);
        state.balloon.timer = setInterval(() => {
          if (state.balloon.collected >= state.balloon.goal) {
            stopBalloonGame();
            return;
          }
          spawn();
        }, state.balloon.spawnMs);
        state.balloon.cleanup.push(() => {
          $area.find(".balloon").remove();
        });
      }
      function stopBalloonGame() {
        if (state.balloon.timer) {
          clearInterval(state.balloon.timer);
          state.balloon.timer = null;
        }
        (state.balloon.cleanup || []).forEach((fn) => {
          try {
            fn();
          } catch {}
        });
        state.balloon.cleanup = [];
      }
      function spawnBalloon($area, pool, target) {
        const isTarget = Math.random() < 0.45;
        const letter = isTarget
          ? target
          : shuffle(pool.filter((l) => l !== target))[0] || target;
        const leftPct = Math.floor(6 + Math.random() * 88);
        const dur = (3 + Math.random() * 2.2).toFixed(2) + "s";
        const color = BAL_COLORS[Math.floor(Math.random() * BAL_COLORS.length)];
        const $b = $('<div class="balloon ' + color + '"></div>');
        $b.css({ left: leftPct + "%", bottom: "-80px", "--dur": dur })
          .attr("data-letter", letter)
          .text(letter);
        $b.on("animationend", function () {
          $(this).remove();
        });
        $b.on("pointerdown", function (e) {
          e.preventDefault();
          const val = $(this).attr("data-letter");
          if ($(this).hasClass("pop")) return;
          const ok = val === target;
          if (ok) {
            $(this).addClass("ring-2 ring-emerald-300 pop");
            state.stars++;
            $("#starCount").text(state.stars);
            setLessonProgress(state.current.id, { stars: state.stars });
            state.balloon.collected++;
            $("#balloonCount").text(
              state.balloon.collected + "/" + state.balloon.goal
            );
            speak("¬°Bien!");
            setTimeout(() => $(this).remove(), 150);
            if (state.balloon.collected >= state.balloon.goal) {
              toast("¬°Meta alcanzada! Pulsa Siguiente");
              speak("¬°Meta alcanzada!");
              stopBalloonGame();
              setNextEnabled(true);
            }
          } else {
            $(this).addClass("ring-2 ring-red-400");
            speak("No");
            setTimeout(() => $(this).removeClass("ring-2 ring-red-400"), 300);
          }
        });
        $area.append($b);
      }

      /* ========= Eventos globales ========= */
      $(function () {
        ensureVoices();
        renderLessonList();
        renderHomeShortcuts();
        $(document).on("click", "[data-jump]", function () {
          startLesson($(this).data("jump"));
        });
        $("#btnBack").on("click", () => {
          stopBalloonGame();
          $("#lessonView").addClass("hidden");
          $("#home").removeClass("hidden");
        });
        $("#btnNext").on("click", nextStep);
        $("#btnRepeat").on("click", () => {});
        $("#toggleAudio").on("change", function () {
          state.audioOn = this.checked;
          toast(this.checked ? "Audio activado" : "Audio desactivado");
        });
        const doReset = () => {
          if (confirm("¬øBorrar progreso?")) {
            localStorage.removeItem(STORAGE_KEY);
            toast("Progreso borrado");
            renderLessonList();
            renderHomeShortcuts();
          }
        };
        $("#btnReset, #btnResetSm").on("click", doReset);
        $("#toggleMenu").on("click", () => $("#sidebar").toggleClass("hidden"));
      });
    </script>
  </body>
</html>
