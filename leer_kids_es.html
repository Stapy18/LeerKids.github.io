<!DOCTYPE html>
<html lang="es" class="">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>LeerKids — Aprende a leer (ES)</title>

    <!-- Aplica el tema ANTES de pintar (default: light) -->
    <script>
      (function setInitialTheme() {
        try {
          var key = "leerkids-theme";
          var saved = localStorage.getItem(key) || "light"; // light por defecto
          if (saved === "dark") {
            document.documentElement.classList.add("dark");
          } else {
            document.documentElement.classList.remove("dark");
          }
        } catch (e) {}
      })();
    </script>

    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- CONFIG de Tailwind: debe ir DESPUÉS del CDN -->
    <script>
      tailwind.config = { darkMode: "class" };
    </script>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap"
      rel="stylesheet"
    />
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <style>
      html,
      body {
        font-family: "Nunito", system-ui, -apple-system, Segoe UI, Roboto;
      }

      /* Globos */
      @keyframes float-up {
        0% {
          transform: translateY(110%);
          opacity: 0;
        }
        8% {
          opacity: 1;
        }
        100% {
          transform: translateY(-600%);
          opacity: 0;
        }
      }
      .balloon {
        position: absolute;
        width: 68px;
        height: 68px;
        border-radius: 9999px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 900;
        box-shadow: 0 10px 22px rgba(0, 0, 0, 0.25);
        animation: float-up var(--dur, 4s) linear forwards;
        user-select: none;
        -webkit-user-select: none;
        color: #fff;
        text-shadow: 0 1px 1px rgba(0, 0, 0, 0.35),
          0 2px 6px rgba(0, 0, 0, 0.35);
      }
      .balloon::after {
        content: "";
        position: absolute;
        bottom: -8px;
        left: 50%;
        transform: translateX(-50%);
        width: 0;
        height: 0;
        border-left: 6px solid transparent;
        border-right: 6px solid transparent;
        border-top: 10px solid rgba(0, 0, 0, 0.35);
      }
      .balloon.pop {
        transform: scale(0.6);
        opacity: 0.1;
        transition: 0.25s ease;
      }

      /* Palabras/frases */
      .word-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 3.5rem;
        border-radius: 1rem;
        font-weight: 900;
      }
      @media (min-width: 640px) {
        .word-btn {
          height: 4rem;
        }
      }
      .drop-pill {
        display: inline-flex;
        align-items: center;
        height: 2.75rem;
        padding: 0 0.75rem;
        border-radius: 9999px;
        font-weight: 800;
        cursor: pointer;
      }
      .btn-next[disabled] {
        opacity: 0.5;
        cursor: not-allowed;
      }
    </style>

    <!-- Tus lecciones externas -->
    <script src="lessons.js"></script>
  </head>
  <body
    class="bg-slate-50 text-slate-900 dark:bg-slate-900 dark:text-slate-100 transition-colors"
  >
    <!-- Header -->
    <header
      class="sticky top-0 z-40 bg-white/90 dark:bg-slate-900/85 backdrop-blur border-b border-slate-200 dark:border-slate-800"
    >
      <div
        class="max-w-6xl mx-auto px-3 sm:px-4 py-2.5 flex items-center gap-2"
      >
        <span
          class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-cyan-50 border border-cyan-100 text-cyan-900 font-extrabold dark:bg-sky-900/40 dark:border-sky-800 dark:text-sky-100"
        >
          📖 <span class="hidden xs:inline">LeerKids</span>
          <span
            class="text-[11px] font-black bg-sky-100 border border-sky-200 rounded-full px-2 py-[2px] dark:bg-sky-800/60 dark:border-sky-700"
            >MVP</span
          >
        </span>

        <div class="text-sm text-slate-600 hidden sm:block dark:text-slate-300">
          Aprende a leer en español
        </div>

        <div class="ml-auto flex items-center gap-1 sm:gap-2">
          <!-- Theme toggle -->
          <button
            id="themeToggle"
            class="inline-flex items-center gap-2 px-3 py-2 rounded-xl border border-slate-200 bg-white text-slate-900 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-100"
            title="Cambiar tema"
          >
            <span id="themeIcon" aria-hidden="true">🌙</span>
            <span class="hidden sm:inline text-sm">Tema</span>
          </button>

          <button
            id="btnReset"
            class="px-3 py-2 rounded-xl border border-slate-200 bg-white text-slate-900 font-bold hidden sm:inline-flex dark:border-slate-700 dark:bg-slate-900 dark:text-slate-100"
          >
            Reiniciar
          </button>
          <button
            id="btnResetSm"
            class="sm:hidden inline-flex items-center justify-center w-10 h-10 rounded-xl border border-slate-200 bg-white text-slate-900 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-100"
            title="Reiniciar"
          >
            ↻
          </button>

          <label
            class="flex items-center gap-1 text-sm px-2 py-1 rounded-xl border border-slate-200 bg-white dark:border-slate-700 dark:bg-slate-900"
          >
            <span aria-hidden="true">🔊</span>
            <input
              id="toggleAudio"
              type="checkbox"
              class="accent-emerald-600"
              checked
              aria-label="Audio"
            />
            <span class="hidden sm:inline">Audio</span>
          </label>
        </div>
      </div>
    </header>

    <!-- Layout (solo columna central) -->
    <main class="max-w-6xl mx-auto px-3 sm:px-4 py-4">
      <section class="space-y-4">
        <!-- Home agrupada por categorías -->
        <div id="home" class="bg-transparent">
          <h1
            class="text-2xl font-extrabold px-1 text-slate-900 dark:text-sky-100"
          >
            ¡Vamos a leer!
          </h1>
          <p class="text-sm text-slate-600 px-1 dark:text-slate-300">
            Módulos: vocales → sílabas → palabras → frases.
          </p>
          <div id="homeGrouped" class="space-y-4 mt-3"></div>
        </div>

        <!-- Vista de lección -->
        <div
          id="lessonView"
          class="hidden bg-white border border-slate-200 rounded-2xl shadow-sm p-4 dark:bg-slate-900/60 dark:border-slate-800"
          role="region"
          aria-label="Actividad de la lección"
        >
          <div class="flex items-center gap-3 flex-wrap">
            <button
              id="btnBack"
              class="px-3 py-2 rounded-xl border border-slate-200 bg-white font-bold dark:border-slate-700 dark:bg-slate-900"
            >
              ← Volver
            </button>
            <div
              id="lessonTitle"
              class="font-extrabold text-slate-900 dark:text-sky-100"
            ></div>
            <div class="text-amber-500 font-black">
              ⭐ <span id="starCount">0</span>
            </div>
          </div>
          <div
            class="h-3 bg-slate-200 rounded-full overflow-hidden mt-2 dark:bg-slate-800"
          >
            <div
              id="progressBar"
              class="h-3 bg-gradient-to-r from-emerald-500 to-sky-500 w-0"
            ></div>
          </div>
          <div id="activity" class="mt-3"></div>
          <div class="flex items-center gap-2 mt-3">
            <button
              id="btnRepeat"
              class="px-3 py-2 rounded-xl border border-slate-200 bg-white dark:border-slate-700 dark:bg-slate-900"
            >
              🔊 Repetir
            </button>
            <button
              id="btnNext"
              class="btn-next px-3 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white font-extrabold"
            >
              Siguiente ▷
            </button>
          </div>
        </div>
      </section>
    </main>

    <div
      id="toast"
      class="fixed bottom-4 right-4 bg-slate-900 text-white px-3 py-2 rounded-xl shadow-lg opacity-0 translate-y-2 transition dark:bg-slate-950"
    ></div>

    <script>
      /* ========= Lecciones desde lessons.js ========= */
      let LESSONS = [];
      (function initLessonsFromJS() {
        if (
          !Array.isArray(window.LEERKIDS_LESSONS) ||
          !window.LEERKIDS_LESSONS.length
        ) {
          alert(
            "No se encontró lessons.js o está vacío. Asegúrate de poner lessons.js junto a index.html."
          );
          window.LEERKIDS_LESSONS = [];
        }
        LESSONS = window.LEERKIDS_LESSONS.map((ls) => {
          let fn = (t) => t;
          if (ls.speakText === "lower") fn = (t) => String(t).toLowerCase();
          else if (ls.speakText === "x" || ls.speakText == null) fn = (t) => t;
          return { ...ls, speakText: fn };
        });
      })();

      /* ========= Estado / utilidades ========= */
      const STORAGE_KEY = "leerkids-progress-v1";
      const state = {
        current: null,
        index: 0,
        stars: 0,
        audioOn: true,
        cacheVoices: [],
        canAdvance: false,
        balloon: {
          timer: null,
          cleanup: [],
          collected: 0,
          goal: 0,
          target: "",
          spawnMs: 650,
        },
      };
      function loadProgress() {
        try {
          return JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
        } catch {
          return {};
        }
      }
      function saveProgress(p) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(p));
      }
      function getLessonProgress(id) {
        const p = loadProgress();
        return p[id] || { done: 0, stars: 0 };
      }
      function setLessonProgress(id, data) {
        const p = loadProgress();
        p[id] = { ...getLessonProgress(id), ...data };
        saveProgress(p);
      }
      function ensureVoices() {
        const load = () => {
          state.cacheVoices = speechSynthesis.getVoices();
        };
        speechSynthesis.addEventListener("voiceschanged", load);
        load();
      }
      function speak(text) {
        if (!state.audioOn) return;
        try {
          speechSynthesis.cancel();
          const u = new SpeechSynthesisUtterance(text);
          const voices = state.cacheVoices.length
            ? state.cacheVoices
            : speechSynthesis.getVoices();
          const v =
            voices.find((v) => /^(es-|es|es_)/i.test(v.lang)) || voices[0];
          if (v) u.voice = v;
          u.rate = 0.95;
          u.pitch = 1;
          u.lang = v?.lang || "es-ES";
          speechSynthesis.speak(u);
        } catch (e) {
          console.warn("No TTS:", e);
        }
      }
      function toast(msg) {
        const el = $("#toast");
        el.text(msg)
          .removeClass("opacity-0 translate-y-2")
          .addClass("opacity-100 translate-y-0");
        setTimeout(
          () =>
            el
              .addClass("opacity-0 translate-y-2")
              .removeClass("opacity-100 translate-y-0"),
          1400
        );
      }
      const shuffle = (a) =>
        a
          .map((v) => [Math.random(), v])
          .sort((x, y) => x[0] - y[0])
          .map((x) => x[1]);
      function setNextEnabled(ok) {
        state.canAdvance = !!ok;
        $("#btnNext").prop("disabled", !ok);
      }
      function shortTitle(s) {
        const base = (s || "").split("(")[0].trim();
        return base.length > 32 ? base.slice(0, 32) + "…" : base;
      }

      /* ========= Agrupar por categoría/subcategoría ========= */
      function groupByCategory(lessons) {
        const catMap = {};
        for (const ls of lessons) {
          const cat = ls.category || "General";
          const sub = ls.subcategory || null;
          catMap[cat] = catMap[cat] || {};
          if (sub) {
            (catMap[cat][sub] ||= []).push(ls);
          } else {
            (catMap[cat]._root ||= []).push(ls);
          }
        }
        return catMap;
      }

      /* ========= HOME AGRUPADA ========= */
      function renderHomeShortcutsGrouped() {
        const $wrap = $("#homeGrouped").empty();
        const groups = groupByCategory(LESSONS);

        Object.keys(groups)
          .sort()
          .forEach((cat) => {
            const $section = $(
              '<section class="bg-white border border-slate-200 rounded-2xl shadow-sm dark:bg-slate-900/60 dark:border-slate-800"></section>'
            );

            // Encabezado colapsado de inicio
            const $header = $(
              '<button type="button" class="w-full flex items-center justify-between px-4 py-3 rounded-t-2xl bg-slate-50 border-b border-slate-200 dark:bg-slate-900/70 dark:border-slate-800"></button>'
            );
            $header.append(
              '<h3 class="text-base sm:text-lg font-extrabold text-slate-800 dark:text-sky-100">' +
                cat +
                "</h3>"
            );
            const $chev = $(`
            <span class="inline-flex items-center justify-center w-7 h-7 rounded-md text-slate-500 border border-slate-200 bg-white dark:text-slate-300 dark:border-slate-700 dark:bg-slate-900">
              <svg class="w-4 h-4 transition-transform duration-200" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.17l3.71-3.94a.75.75 0 111.08 1.04l-4.24 4.5a.75.75 0 01-1.08 0l-4.24-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd" />
              </svg>
            </span>`);
            $header.append($chev);

            const $content = $('<div class="p-3 space-y-3 hidden"></div>'); // hidden por defecto
            let collapsed = true;
            $chev.find("svg").css("transform", "rotate(-90deg)"); // cerrado

            $header.on("click", () => {
              collapsed = !collapsed;
              $content.toggleClass("hidden", collapsed);
              $chev
                .find("svg")
                .css(
                  "transform",
                  collapsed ? "rotate(-90deg)" : "rotate(0deg)"
                );
            });
            $section.append($header);

            // Si es SÍLABAS, unimos todos los subgrupos
            if (
              cat.toLowerCase() === "sílabas" ||
              cat.toLowerCase() === "silabas"
            ) {
              const all = [];
              const root = groups[cat]._root || [];
              all.push(...root);
              Object.keys(groups[cat])
                .filter((k) => k !== "_root")
                .forEach((sub) => {
                  all.push(...groups[cat][sub]);
                });
              const $grid = $(
                '<div class="grid [grid-template-columns:repeat(auto-fit,minmax(160px,1fr))] gap-3"></div>'
              );
              all.forEach((ls) => $grid.append(homeCard(ls)));
              $content.append($grid);
            } else {
              const root = groups[cat]._root || [];
              if (root.length) {
                const $grid = $(
                  '<div class="grid [grid-template-columns:repeat(auto-fit,minmax(160px,1fr))] gap-3"></div>'
                );
                root.forEach((ls) => $grid.append(homeCard(ls)));
                $content.append($grid);
              }
              Object.keys(groups[cat])
                .filter((k) => k !== "_root")
                .sort()
                .forEach((sub) => {
                  const $sub = $('<div class=""></div>');
                  $sub.append(
                    '<div class="text-[11px] font-black uppercase tracking-wide text-slate-500 px-1 mb-1 dark:text-slate-400">' +
                      sub +
                      "</div>"
                  );
                  const $grid = $(
                    '<div class="grid [grid-template-columns:repeat(auto-fit,minmax(160px,1fr))] gap-3"></div>'
                  );
                  groups[cat][sub].forEach((ls) => $grid.append(homeCard(ls)));
                  $sub.append($grid);
                  $content.append($sub);
                });
            }

            $section.append($content);
            $wrap.append($section);
          });
      }

      function homeCard(ls) {
        let big = "📚";
        if (ls.kind === "choice-sound") {
          big = (ls.pool?.[0] || "") + (ls.pool?.[1] ? " • " + ls.pool[1] : "");
        } else if (ls.kind === "picture-pick") {
          big = ls.pool?.[0]?.emoji || "🖼️";
        } else if (ls.kind === "build-phrase") {
          big = "🧩";
        } else if (ls.kind === "balloon-hunt") {
          big = "🎈";
        }
        return $(
          '<button class="flex flex-col items-center justify-start gap-1 p-4 h-auto min-h-[108px] bg-white border border-slate-200 rounded-2xl shadow-sm hover:shadow transition active:scale-[.99] text-center dark:bg-slate-900 dark:border-slate-800" data-jump="' +
            ls.id +
            '">\
          <span class="text-xl font-extrabold">' +
            big +
            '</span>\
          <span class="text-xs sm:text-[13px] text-slate-700 font-extrabold leading-snug dark:text-slate-200">' +
            shortTitle(ls.title) +
            "</span>\
        </button>"
        );
      }

      /* ========= Flujo de lección ========= */
      function startLesson(id) {
        stopBalloonGame();
        state.current = LESSONS.find((x) => x.id === id);
        state.index = 0;
        state.stars = getLessonProgress(id).stars || 0;
        $("#home").addClass("hidden");
        $("#lessonView").removeClass("hidden");
        $("#lessonTitle").text(state.current.title);
        $("#starCount").text(state.stars);
        renderStep();
      }

      function renderStep() {
        const ls = state.current;
        if (!ls) return;
        const total = ls.items.length;
        $("#progressBar").css("width", (state.index / total) * 100 + "%");
        const item = ls.items[state.index];
        setNextEnabled(false);

        if (ls.kind === "choice-sound") {
          const opts = shuffle(ls.pool).slice(0, 4);
          if (!opts.includes(item)) {
            opts[Math.floor(Math.random() * opts.length)] = item;
          }
          $("#activity").html(
            '<div class="text-sm text-slate-600 dark:text-slate-300">' +
              ls.prompt +
              '</div>\
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mt-3">' +
              opts
                .map(
                  (o) =>
                    '<div class="flex items-center justify-center h-20 text-2xl font-black bg-white border border-slate-200 rounded-2xl cursor-pointer dark:bg-slate-900 dark:border-slate-800" data-val="' +
                    o +
                    '">' +
                    o +
                    "</div>"
                )
                .join("") +
              "</div>"
          );
          const say = ls.speakText(item);
          const play = () => speak(say);
          $("#btnRepeat").off().on("click", play);
          setTimeout(play, 200);
          $("#activity [data-val]").on("click", function () {
            const val = $(this).data("val");
            const $g = $(this).closest('[class*="grid"]');
            $g.find("[data-val]").removeClass(
              "ring-2 ring-red-400 ring-emerald-400"
            );
            const correct = val === item;
            $(this).addClass(
              correct ? "ring-2 ring-emerald-400" : "ring-2 ring-red-400"
            );
            if (correct) {
              speak("¡Muy bien!");
              state.stars++;
              $("#starCount").text(state.stars);
              setLessonProgress(ls.id, { stars: state.stars });
              setNextEnabled(true);
            } else {
              speak("Intenta de nuevo");
              setNextEnabled(false);
            }
          });
        } else if (ls.kind === "picture-pick") {
          const opts = shuffle(ls.pool).slice(0, 4);
          const needle = ls.pool.find((p) => p.w === item) || opts[0];
          if (!opts.some((x) => x.w === item)) {
            opts[Math.floor(Math.random() * opts.length)] = needle;
          }
          $("#activity").html(
            '<div class="text-sm text-slate-600 dark:text-slate-300">' +
              ls.prompt +
              '</div>\
            <div class="flex items-center justify-center h-24 text-6xl">' +
              needle.emoji +
              '</div>\
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mt-3">' +
              opts
                .map(
                  (o) =>
                    '<div class="flex items-center justify-center h-16 text-xl font-black bg-white border border-slate-200 rounded-2xl cursor-pointer dark:bg-slate-900 dark:border-slate-800" data-val="' +
                    o.w +
                    '">' +
                    o.w +
                    "</div>"
                )
                .join("") +
              "</div>"
          );
          const say = needle.w.toLowerCase();
          const play = () => speak(say);
          $("#btnRepeat").off().on("click", play);
          setTimeout(play, 200);
          $("#activity [data-val]").on("click", function () {
            const val = $(this).data("val");
            const $g = $(this).closest('[class*="grid"]');
            $g.find("[data-val]").removeClass(
              "ring-2 ring-red-400 ring-emerald-400"
            );
            const correct = val === item;
            $(this).addClass(
              correct ? "ring-2 ring-emerald-400" : "ring-2 ring-red-400"
            );
            if (correct) {
              speak("¡Muy bien!");
              state.stars++;
              $("#starCount").text(state.stars);
              setLessonProgress(ls.id, { stars: state.stars });
              setNextEnabled(true);
            } else {
              speak("Intenta de nuevo");
              setNextEnabled(false);
            }
          });
        } else if (ls.kind === "build-phrase") {
          const entry = ls.pool[item];
          const parts = shuffle(entry.parts.slice());
          $("#activity").html(
            '<div class="text-sm text-slate-600 dark:text-slate-300">' +
              ls.prompt +
              '</div>\
            <div id="drop" class="min-h-[84px] bg-white border border-slate-200 rounded-2xl p-3 mt-2 flex flex-wrap gap-2 dark:bg-slate-900 dark:border-slate-800"></div>\
            <div id="phraseBank" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-3 mt-3">' +
              parts
                .map(
                  (p, i) =>
                    '<button class="word-btn bg-white border border-slate-200 text-base sm:text-lg cursor-pointer dark:bg-slate-900 dark:border-slate-800" data-word="' +
                    p +
                    '" data-idx="' +
                    i +
                    '">' +
                    p +
                    "</button>"
                )
                .join("") +
              "</div>"
          );
          const speakPhrase = () => speak(entry.phrase.toLowerCase());
          $("#btnRepeat").off().on("click", speakPhrase);
          setTimeout(speakPhrase, 200);
          function checkOK() {
            const built = $("#drop [data-part]")
              .map((i, el) => $(el).data("part"))
              .get();
            const ok = built.join(" ") === entry.parts.join(" ");
            setNextEnabled(ok);
            return ok;
          }
          $("#phraseBank [data-word]").on("click", function () {
            if ($(this).prop("disabled")) return;
            const w = $(this).data("word"),
              idx = $(this).data("idx");
            $(this)
              .prop("disabled", true)
              .addClass("opacity-50 cursor-not-allowed");
            $("#drop").append(
              '<span class="drop-pill bg-sky-50 border border-sky-200 text-base sm:text-lg dark:bg-sky-900/40 dark:border-sky-800" data-part="' +
                w +
                '" data-idx="' +
                idx +
                '" title="Quitar">' +
                w +
                "</span>"
            );
            checkOK();
          });
          $("#drop")
            .off()
            .on("click", "[data-idx]", function () {
              const idx = $(this).data("idx");
              $(this).remove();
              const $b = $('#phraseBank [data-idx="' + idx + '"]');
              $b.prop("disabled", false).removeClass(
                "opacity-50 cursor-not-allowed"
              );
              checkOK();
            });
        } else if (ls.kind === "balloon-hunt") {
          startBalloonGame(ls, item);
          setNextEnabled(false);
        }
      }

      function nextStep() {
        const ls = state.current;
        if (!ls) return;
        if (!state.canAdvance) {
          speak("Primero completa este paso");
          toast("Primero completa este paso");
          return;
        }
        if (ls.kind === "balloon-hunt") {
          stopBalloonGame();
        }
        state.index++;
        const total = state.current.items.length;
        setLessonProgress(state.current.id, {
          done: Math.max(getLessonProgress(ls.id).done, state.index),
        });
        if (state.index >= total) {
          $("#progressBar").css("width", "100%");
          speak("¡Excelente! Lección completa.");
          toast("Lección completa ✨");
          $("#lessonView").addClass("hidden");
          $("#home").removeClass("hidden");
          renderHomeShortcutsGrouped();
        } else {
          renderStep();
        }
      }

      /* ========= Globos ========= */
      const BAL_COLORS = [
        "bg-rose-500",
        "bg-red-500",
        "bg-orange-500",
        "bg-amber-500",
        "bg-emerald-500",
        "bg-teal-500",
        "bg-sky-500",
        "bg-blue-500",
        "bg-violet-500",
        "bg-fuchsia-500",
      ];
      function startBalloonGame(ls, item) {
        stopBalloonGame();
        const goal = ls.goal || 10;
        state.balloon.collected = 0;
        state.balloon.goal = goal;
        state.balloon.target = item;
        const promptText = `${ls.prompt} ${item}. Toca ${goal}.`;
        $("#activity").html(
          '<div class="text-sm text-slate-600 dark:text-slate-300">' +
            promptText +
            '</div>\
          <div class="flex items-center gap-2 mt-2 text-sm">\
            <span class="font-extrabold">Objetivo:</span> <span class="px-2 py-1 rounded-full bg-emerald-50 text-emerald-700 border border-emerald-200 dark:bg-emerald-900/40 dark:text-emerald-300 dark:border-emerald-800">' +
            item +
            '</span>\
            <span class="ml-2 font-extrabold">Llevas:</span> <span id="balloonCount" class="px-2 py-1 rounded-full bg-slate-100 border border-slate-200 dark:bg-slate-900 dark:border-slate-800">0/' +
            goal +
            '</span>\
          </div>\
          <div id="balloonArea" class="relative overflow-hidden bg-gradient-to-t from-sky-50 to-white border border-slate-200 rounded-2xl mt-3 dark:from-sky-950 dark:to-slate-900 dark:border-slate-800" style="height:360px;cursor:pointer;"></div>'
        );
        const say = () => {
          speak("Toca todos los globos con la letra");
          setTimeout(() => speak(item), 240);
        };
        $("#btnRepeat").off().on("click", say);
        setTimeout(say, 120);
        const $area = $("#balloonArea");
        const spawn = () => spawnBalloon($area, ls.pool, item);
        state.balloon.timer = setInterval(() => {
          if (state.balloon.collected >= state.balloon.goal) {
            stopBalloonGame();
            return;
          }
          spawn();
        }, state.balloon.spawnMs);
        state.balloon.cleanup.push(() => {
          $area.find(".balloon").remove();
        });
      }
      function stopBalloonGame() {
        if (state.balloon.timer) {
          clearInterval(state.balloon.timer);
          state.balloon.timer = null;
        }
        (state.balloon.cleanup || []).forEach((fn) => {
          try {
            fn();
          } catch {}
        });
        state.balloon.cleanup = [];
      }
      function spawnBalloon($area, pool, target) {
        const isTarget = Math.random() < 0.45;
        const letter = isTarget
          ? target
          : shuffle(pool.filter((l) => l !== target))[0] || target;
        const leftPct = Math.floor(6 + Math.random() * 88);
        const dur = (3 + Math.random() * 2.2).toFixed(2) + "s";
        const color = BAL_COLORS[Math.floor(Math.random() * BAL_COLORS.length)];
        const $b = $('<div class="balloon ' + color + '"></div>');
        $b.css({ left: leftPct + "%", bottom: "-80px", "--dur": dur })
          .attr("data-letter", letter)
          .text(letter);
        $b.on("animationend", function () {
          $(this).remove();
        });
        $b.on("pointerdown", function (e) {
          e.preventDefault();
          const val = $(this).attr("data-letter");
          if ($(this).hasClass("pop")) return;
          const ok = val === target;
          if (ok) {
            $(this).addClass("ring-2 ring-emerald-300 pop");
            state.stars++;
            $("#starCount").text(state.stars);
            setLessonProgress(state.current.id, { stars: state.stars });
            state.balloon.collected++;
            $("#balloonCount").text(
              state.balloon.collected + "/" + state.balloon.goal
            );
            speak("¡Bien!");
            setTimeout(() => $(this).remove(), 150);
            if (state.balloon.collected >= state.balloon.goal) {
              toast("¡Meta alcanzada! Pulsa Siguiente");
              speak("¡Meta alcanzada!");
              stopBalloonGame();
              setNextEnabled(true);
            }
          } else {
            $(this).addClass("ring-2 ring-red-400");
            speak("No");
            setTimeout(() => $(this).removeClass("ring-2 ring-red-400"), 300);
          }
        });
        $area.append($b);
      }

      /* ========= Eventos ========= */
      $(function () {
        ensureVoices();
        renderHomeShortcutsGrouped();

        // THEME TOGGLE
        const THEME_KEY = "leerkids-theme";
        const btn = document.getElementById("themeToggle");
        const icon = document.getElementById("themeIcon");
        function refreshIcon() {
          if (icon)
            icon.textContent = document.documentElement.classList.contains(
              "dark"
            )
              ? "🌞"
              : "🌙";
        }
        refreshIcon();
        if (btn) {
          btn.addEventListener("click", () => {
            const root = document.documentElement;
            root.classList.toggle("dark");
            localStorage.setItem(
              THEME_KEY,
              root.classList.contains("dark") ? "dark" : "light"
            );
            refreshIcon();
          });
        }

        $(document).on("click", "[data-jump]", function () {
          startLesson($(this).data("jump"));
        });
        $("#btnBack").on("click", () => {
          stopBalloonGame();
          $("#lessonView").addClass("hidden");
          $("#home").removeClass("hidden");
        });
        $("#btnNext").on("click", nextStep);
        $("#btnRepeat").on("click", () => {});
        $("#toggleAudio").on("change", function () {
          state.audioOn = this.checked;
          toast(this.checked ? "Audio activado" : "Audio desactivado");
        });
        const doReset = () => {
          if (confirm("¿Borrar progreso?")) {
            localStorage.removeItem(STORAGE_KEY);
            toast("Progreso borrado");
            renderHomeShortcutsGrouped();
          }
        };
        $("#btnReset, #btnResetSm").on("click", doReset);
      });
    </script>
  </body>
</html>
